(window.webpackJsonp=window.webpackJsonp||[]).push([["bundle_plugin_titlesync"],{"./src/base/storage/storage.ts":function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));n("../node_modules/core-js/modules/es.array.concat.js"),n("../node_modules/core-js/modules/es.array.for-each.js"),n("../node_modules/core-js/modules/es.object.keys.js"),n("../node_modules/core-js/modules/web.dom-collections.for-each.js");function o(e,t){t.createdDate=+new Date;var n="docs_actions",o=function(e){if("undefined"!==typeof window.Storage)return localStorage.getItem(e)}(n);o=o&&JSON.parse(o)||[];var r={};o.forEach((function(e,t){var n=e.data;r["".concat(n.localPadId,"$").concat(n.domainId)]={index:t,type:e.type,value:n}}));var s=r["".concat(t.localPadId,"$").concat(t.domainId)];if(s){for(var a=0,i=Object.keys(t);a<i.length;a++){var c=i[a];s.value[c]=t[c]}o[s.index]={type:"ADD"===s.type&&"MODIFY"===e?"ADD":e,data:s.value}}else o.push({type:e,data:t});!function(e,t){"undefined"!==typeof window.Storage&&localStorage.setItem(e,t)}(n,JSON.stringify(o))}},"./src/core/utils/config.ts":function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));n("../node_modules/core-js/modules/es.array.index-of.js");var o=n("./src/core/data/configService/spreadConfig.ts");function r(){return-1!==["local","new"].indexOf(o.a.getConfig("padStatus"))}},"./src/external/documentInfoSync/DocumentInfoSync.ts":function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"PadInfoKey",(function(){return o}));n("../node_modules/core-js/modules/es.array.concat.js"),n("../node_modules/core-js/modules/es.regexp.exec.js"),n("../node_modules/core-js/modules/es.string.replace.js"),n("../node_modules/regenerator-runtime/runtime.js");var o,r=n("../node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js"),s=n("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),a=n("../node_modules/@babel/runtime/helpers/esm/createClass.js"),i=n("../node_modules/axios/index.js"),c=n.n(i),l=n("../packages/utils/src/safe.ts"),u=n("./src/core/data/configService/spreadConfig.ts"),d=n("./src/base/error/errCodeType.ts"),p=n("./src/base/event/event.ts"),f=n("./src/external/offlineEdit/model/ClearType.ts"),h=n("./src/core/utils/config.ts");!function(e){e[e.privilegeAttribute=1]="privilegeAttribute",e[e.title=2]="title"}(o||(o={}));var m=function(){function t(e){var n=this;Object(s.a)(this,t),this.SYNC_CGI_URL="//".concat(location.host,"/cgi-go/padinfo/getpadinfo"),this.handleNetworkStatusChange=function(e,t){t.isOnline&&!e.isOnline&&n.syncDocumentInfo(n.secretId)},this.app=e,this.secretId=location.pathname.replace("/sheet/",""),this.init()}return Object(a.a)(t,[{key:"init",value:function(){"D0000000000000001"!==this.secretId&&(this.syncDocumentInfo(this.secretId),this.app.sheetStatus.workbookStatus.status.change(this.handleNetworkStatusChange))}},{key:"destory",value:function(){this.app.sheetStatus.workbookStatus.status.offChange(this.handleNetworkStatusChange)}},{key:"syncDocumentInfo",value:function(){var t=Object(r.a)(regeneratorRuntime.mark((function t(n){var s,a,i=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!Object(h.a)()){t.next=2;break}return t.abrupt("return");case 2:return s="&infoKeys=[".concat([o.privilegeAttribute,o.title],"]"),a="".concat(this.SYNC_CGI_URL,"?encodePadId=").concat(n).concat(s,"&xsrf=").concat(Object(l.b)()),t.next=6,c()({method:"get",url:a,responseType:"json"}).then(function(){var t=Object(r.a)(regeneratorRuntime.mark((function t(n){var o,r,s,a,c;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null===(o=e.log)||void 0===o||o.info(n),0!==(r=n.data).retcode){t.next=12;break}return s=r.data,a=s.privilegeAttribute,t.next=7,i.handlePrivilegeChange(a);case 7:return c=s.title,t.next=10,i.handleTitleChange(c);case 10:t.next=13;break;case 12:r.retcode;case 13:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()).catch((function(t){var n;null===(n=e.log)||void 0===n||n.error("syncDocumentInfo error",null===t||void 0===t?void 0:t.stack)}));case 6:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"handleTitleChange",value:function(){var e=Object(r.a)(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(u.a.getConfig("title")!==t){e.next=3;break}return e.abrupt("return");case 3:return n=u.a.getConfig("globalPadId"),e.next=6,this.app.offlineEdit.offlineDataManager.getHelper().updatePadInfo(n,{newTitle:t,last_modify_ts:Date.now()});case 6:u.a.setConfig({title:t});case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"handlePrivilegeChange",value:function(){var e=Object(r.a)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:u.a.getConfig("canEdit")===t.can_edit&&u.a.getConfig("canRead")===t.can_read||(p.c.spreadsheetEvent.trigger("clearOfflineStore",{type:f.a.ALL}),this.app.socket.client.shutDown(d.a.PERMISSION_CHANGE),this.app.permissions.activeShutdownStatus(!1),$("#editor").blur()),u.a.getConfig("canComment")!==t.can_comment&&(p.c.spreadsheetEvent.trigger("clearOfflineStore",{type:f.a.ALL}),this.app.permissions.setWorkbookStatusCanComment(!1),this.app.socket.client.shutDown(d.a.PERMISSION_CHANGE)),u.a.getConfig("canCopy")!==t.can_copy&&(p.c.spreadsheetEvent.trigger("clearOfflineStore",{type:f.a.ALL}),this.app.permissions.setWorkbookStatusCanCopy(!1),this.app.socket.client.shutDown(d.a.PERMISSION_CHANGE));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),t}();t.default=m}.call(this,n("../node_modules/webpack/buildin/global.js"))},"./src/external/offlineEdit/model/ClearType.ts":function(e,t,n){"use strict";var o;n.d(t,"a",(function(){return o})),function(e){e.ALL="all",e.COMMITTED="committed",e.UN_COMMITTED="unCommitted"}(o||(o={}))},"./src/external/titleSync/titleSync.ts":function(e,t,n){"use strict";n.r(t),function(e){n("../node_modules/core-js/modules/es.array.concat.js"),n("../node_modules/core-js/modules/es.array.slice.js"),n("../node_modules/core-js/modules/es.number.constructor.js"),n("../node_modules/core-js/modules/es.object.get-own-property-descriptor.js"),n("../node_modules/core-js/modules/es.object.to-string.js"),n("../node_modules/core-js/modules/es.reflect.construct.js"),n("../node_modules/core-js/modules/es.regexp.exec.js"),n("../node_modules/core-js/modules/es.regexp.to-string.js"),n("../node_modules/core-js/modules/es.string.replace.js"),n("../node_modules/regenerator-runtime/runtime.js");var o=n("../node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js"),r=n("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("../node_modules/@babel/runtime/helpers/esm/createClass.js"),a=n("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),i=n("../node_modules/@babel/runtime/helpers/esm/inherits.js"),c=n("../node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn.js"),l=n("../node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js"),u=n("../node_modules/@babel/runtime/helpers/esm/wrapNativeSuper.js"),d=n("../node_modules/@babel/runtime/helpers/esm/typeof.js"),p=n("./src/base/event/eventName.ts"),f=n("./src/base/storage/storage.ts"),h=n("../packages/common-utils/src/url.ts"),m=n("../packages/report/src/index.ts"),g=n("./src/core/ui/toast/index.ts"),b=n("./src/core/data/configService/spreadConfig.ts"),v=n("../node_modules/@tencent/docs-user-agent/dist/index.js"),j=n.n(v),y=n("./src/core/app/SpreadsheetApp.interface.ts"),w=n("../packages/services/src/dispose.ts");function _(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function O(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=Object(l.a)(e);if(t){var r=Object(l.a)(this).constructor;n=Reflect.construct(o,arguments,r)}else n=o.apply(this,arguments);return Object(c.a)(this,n)}}var T=function(e,t,n,o){var r,s=arguments.length,a=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"===("undefined"===typeof Reflect?"undefined":Object(d.a)(Reflect))&&"function"===typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var i=e.length-1;i>=0;i--)(r=e[i])&&(a=(s<3?r(a):s>3?r(t,n,a):r(t,n))||a);return s>3&&a&&Object.defineProperty(t,n,a),a},C=function(e,t){return function(n,o){t(n,o,e)}},S=function(e){Object(i.a)(n,e);var t=O(n);function n(){return Object(a.a)(this,n),t.call(this,"Title is illegal")}return n}(Object(u.a)(Error)),k=function(){function t(e){var n=this;Object(a.a)(this,t),this.app=e,this.disposables=new w.b,this._handleUpdateTitleServer=function(e){n.titleEffect(e)},this._handleTitleAutoChange=function(){n.titleUpdateTips()},this._handleUpdateTitleLocal=function(e,t){n.setDocumentTitleToServer(t).catch((function(){return n.app.spreadsheet.setTitle(e,!0)})),n.titleEffect(t)}}return Object(s.a)(t,[{key:"init",value:function(){this.bindEvents(),this.app.spreadsheet.setTitle(b.a.getConfig("title"),!0)}},{key:"destroy",value:function(){this.disposables.dispose(),this.app.event.spreadsheetEvent.remove(p.a.TITLE_AUTO_CHANGE,this._handleTitleAutoChange),Object(g.hideToast)()}},{key:"bindEvents",value:function(){var e=this;this.disposables.add(this.app.spreadsheet.onUpdateTitle((function(t){t.isServer?e._handleUpdateTitleServer(t.newTitle):e._handleUpdateTitleLocal(t.oldTitle,t.newTitle)}))),this.app.event.spreadsheetEvent.listen(p.a.TITLE_AUTO_CHANGE,this._handleTitleAutoChange)}},{key:"titleUpdateTips",value:function(){var e=this;if(localStorage){var t=Number(localStorage.getItem("titleAutoSyncTipsTime"))||0;if(t<=2){if(j.a.isMobile||j.a.isIPad){var n={isNeedBtn:!0,btnText:"\u70b9\u51fb\u4fee\u6539",btnCallBack:function(){e.app.view.header.component.showRenameDialog()}};Object(g.showToast)("\u5df2\u81ea\u52a8\u540c\u6b65\u6807\u9898\uff0c",void 0,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_(Object(n),!0).forEach((function(t){Object(r.a)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({toolToastCloseTime:5e3,supportMobile:!0},n))}else Object(g.showToast)("\u5df2\u81ea\u52a8\u751f\u6210\u6807\u9898\uff0c\u70b9\u51fb\u6807\u9898\u53ef\u8fdb\u884c\u4fee\u6539\u3002",void 0,{toolToastCloseTime:5e3,supportMobile:!0});t+=1,localStorage.setItem("titleAutoSyncTipsTime",String(t))}}}},{key:"setOfflineStoreTitle",value:function(e){"undefined"!==typeof window.Storage&&(e?localStorage.setItem("offline_title_".concat(b.a.getConfig("padId")),e):localStorage.removeItem("offline_title_".concat(b.a.getConfig("padId"))))}},{key:"setDocumentTitleToServer",value:function(){var t=Object(o.a)(regeneratorRuntime.mark((function t(n){var o,r,s,a,i,c,l,u;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=n.replace(/[\\\/:*?"<>|]/g,"").slice(0,128)||"\u65e0\u6807\u9898\u8868\u683c",o=b.a.getConfig("creatorDomain"),r=b.a.getConfig("domainId"),s=b.a.getConfig("padId"),this.setOfflineStoreTitle(n),Object(f.a)("MODIFY",{domainId:r,localPadId:s,title:n,actiontoserver:1}),a=Object(h.updateURLParameters)("//".concat(location.host,"/cgi-bin/redirect/").concat(o,"/ep/api/changetitle"),{localPadId:s,newTitle:n}),t.prev=7,t.next=10,$.post(a,{});case 10:if(0!==(i=t.sent).retcode&&"0"!==i.retcode){t.next=17;break}b.a.setConfig({isUserChangeTitle:1,title:n});try{Object(f.a)("MODIFY",{domainId:r,localPadId:s,title:n,title_sort_priority:i.doc_info.title_sort_priority,title_sort_value:i.doc_info.title_sort_value}),c=localStorage.getItem("tdsourcetag"),m.b.tdwReport({opername:"doc_core",module:"edit",action:"modify_title",source3:c||""})}catch(d){console.error(d)}this.setOfflineStoreTitle(""),t.next=23;break;case 17:if(null===(l=e.log)||void 0===l||l.warn("request changetitle response. retcode = ".concat(i.retcode," cgicode = ").concat(i.cgicode)),12e3!==parseInt(i.retcode,10)&&12e3!==parseInt(i.cgicode,10)){t.next=22;break}throw new S;case 22:throw Error("Set title failed");case 23:t.next=30;break;case 25:throw t.prev=25,t.t0=t.catch(7),null===(u=e.log)||void 0===u||u.error("\u6807\u9898\u4fee\u6539\u5931\u8d25",null===t.t0||void 0===t.t0?void 0:t.t0.stack),t.t0 instanceof S?Object(g.showToast)("\u6807\u9898\u4e0d\u5408\u89c4\uff0c\u8bf7\u91cd\u65b0\u547d\u540d\u3002",void 0,{toolToastCloseTime:5e3,supportMobile:!0}):Object(g.showToast)("\u4fee\u6539\u6807\u9898\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5\u3002",void 0,{toolToastCloseTime:5e3,supportMobile:!0}),t.t0;case 30:case"end":return t.stop()}}),t,this,[[7,25]])})));return function(e){return t.apply(this,arguments)}}()},{key:"titleEffect",value:function(t){if(j.a.isMobilePhone||j.a.isAndroidPad||j.a.isIPad){var n,o,r,s,a,i,c,l,u;if(null===(n=e.CoreSheet)||void 0===n||null===(o=n.shareController)||void 0===o||o.setShareInfo(),j.a.isTencentDocsApp)null===(r=window)||void 0===r||null===(s=r.mqq)||void 0===s||s.invoke("ui","setWebviewNaviTitle",{title:t,url:window.location.href});if(document.title=t,j.a.isIOS)null===(a=window)||void 0===a||null===(i=a.mqq)||void 0===i||null===(c=i.ui)||void 0===c||c.refreshTitle();if(!j.a.isIOS)try{var d,p;null===(d=window)||void 0===d||null===(p=d.mqq)||void 0===p||p.invoke("ui","setSharedDocNativeKeyboardEnable",{enable:0,source:0},(function(){}))}catch(f){}if(j.a.isMiniProgram)null===(l=window)||void 0===l||null===(u=l.wx)||void 0===u||u.miniProgram.postMessage({data:{title:t}});window.clientVars.padTitle=t,this.app.event.default.trigger("title-update-m",t)}else{try{document.title=t,window.clientVars.padTitle=t}catch(f){}this.app.event.default.trigger("title-update-pc",{title:t})}}}]),t}();k=T([C(0,y.a)],k),t.default=k}.call(this,n("../node_modules/webpack/buildin/global.js"))}}]);
//# sourceMappingURL=pc-bundle_plugin_titlesync-1de06c7dc0.js.map