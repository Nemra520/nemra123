(window.webpackJsonp=window.webpackJsonp||[]).push([["bundle_plugin_fullmember"],{"../node_modules/@tencent/doc-visibilitychange/dist/tabkit.js":function(t,e,i){(function(e){t.exports=function(t){var e={};function i(n){if(e[n])return e[n].exports;var s=e[n]={i:n,l:!1,exports:{}};return t[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(n,s,function(e){return t[e]}.bind(null,s));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=3)}({3:function(t,e,i){"use strict";i.r(e);var n,s=function(){function t(t){this.taskId=this.getRandomId(),this.taskFunction=t}return t.prototype.exec=function(){this.taskFunction()},t.prototype.getRandomId=function(){return Date.now().toString(32)+Math.random().toString(32).substring(2)},t}();void 0!==document.hidden?n="visibilitychange":void 0!==document.msHidden?n="msvisibilitychange":void 0!==document.webkitHidden&&(n="webkitvisibilitychange");var a,r,o,u=new(function(){function t(){var t=this;this.visibleTasks=[],this.hiddenTasks=[],this.destroyTasks=[],document.addEventListener(n,(function(){"hidden"===document.visibilityState&&t.hiddenTasks.forEach((function(t){return t.exec()})),"visible"===document.visibilityState&&t.visibleTasks.forEach((function(t){return t.exec()}))}))}return t.prototype.registerOnVisible=function(t){var e=new s(t);return this.visibleTasks.push(e),e.taskId},t.prototype.registerOnHidden=function(t){var e=new s(t);return this.hiddenTasks.push(e),e.taskId},t.prototype.registerOnDestory=function(t){var e=new s(t);return this.destroyTasks.push(e),e.taskId},t.prototype.destroy=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];e.forEach((function(e){t.destroyTasks.find((function(t){return t.taskId===e})).exec()}))},t.prototype.clear=function(){this.visibleTasks.length=0,this.hiddenTasks.length=0,this.destroyTasks.length=0},t}());!function(t){t.TabCountChange="TabCountChange",t.SuspendTab="SuspendTab"}(a||(a={})),function(t){t.Active="active",t.Inactive="inactive"}(r||(r={})),function(t){t.ReactivateTab="reactivate_tab",t.SuspendTab="suspend_tab",t.ReportOnly="report_only"}(o||(o={}));var l=/^tabStatus/,c=function(){function t(t){var e=this;this.suspendTimer=0,this.updateTimer=0,this.tabCount=1,this.disabledTime=36e4,this.tabCountLimit=0,this.handleStorageChange=function(){var t=e.getTabCount();t!==e.tabCount&&(e.listener.get(a.TabCountChange).forEach((function(t){return t()})),e.updateTabCount(t))},this.handleUnload=function(){localStorage.removeItem("tabStatus_"+e.id),e.destroy()},this.handleVisibilityChange=function(){if("visible"===document.visibilityState){clearTimeout(e.suspendTimer);var t=Date.now();e.report(o.ReactivateTab,t),e.updateCurTabStatus({activeTime:t,leaveTime:t,suspended:!1}),e.checkStatus()}else t=Date.now(),e.updateCurTabStatus({leaveTime:t}),clearTimeout(e.beatTimer)},this.options=t,this.count=this.getTabCount()||0,this.beatTimer=0,this.tabCountLimit=t.tabCountLimit||50,this.suspendTabTimeLimit=t.suspendTabTimeLimit||216e5,this.id=t.docId+"_"+this.getUniqId(),this.listener=new Map,this.log=t.log,this.handleLoad(),this.initEvent()}return Object.defineProperty(t.prototype,"defaultReportOptions",{get:function(){return{tab_count:this.getTabCount(),tab_limit:this.tabCountLimit,time_limit:this.suspendTabTimeLimit}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reportReactivateTimeLimit",{get:function(){return Math.floor(.8*this.suspendTabTimeLimit)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"beatTime",{get:function(){return Math.min(3e5,Math.max(this.suspendTabTimeLimit/10,1e4))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"logOptions",{get:function(){return{tab_count:this.getTabCount()}},enumerable:!1,configurable:!0}),t.prototype.getTabStatus=function(t){var e=localStorage.getItem("tabStatus_"+t);if(e)return JSON.parse(e)},t.prototype.setTabStatus=function(t,e){localStorage.setItem("tabStatus_"+t,JSON.stringify(e))},t.prototype.setTabCountLimit=function(t){this.tabCountLimit=t},t.prototype.checkStatus=function(){var t=this;clearInterval(this.beatTimer),this.beatTimer=setInterval((function(){var e=t.getAllTabStatus(),i=Object.keys(e),n=Date.now();i.forEach((function(i){var s=e[i];(!s||n-s>t.disabledTime)&&localStorage.removeItem(i)}))}),this.beatTime)},t.prototype.getCurTabStatus=function(){return this.getTabStatus(this.id)},t.prototype.getAllTabStatus=function(){var t={};return Object.keys(localStorage).forEach((function(e){l.test(e)&&(t[e]=e)})),t},t.prototype.getTabCount=function(){var t=0;return Object.keys(localStorage).forEach((function(e){l.test(e)&&(t+=1)})),t},t.prototype.addListener=function(t,e){var i=this.listener.get(t);i||(i=[],this.listener.set(t,i)),i.push(e)},t.prototype.removeListener=function(t,e){if(this.listener.has(t)){var i=this.listener.get(t),n=i.indexOf(e);-1!==n&&i.splice(n,1)}},t.prototype.destroy=function(){this.listener.clear(),clearTimeout(this.beatTimer),clearTimeout(this.updateTimer),document.removeEventListener("visibilitychange",this.handleVisibilityChange),window.removeEventListener("beforeunload",this.handleUnload),window.removeEventListener("storage",this.handleStorageChange)},t.prototype.initEvent=function(){document.addEventListener("visibilitychange",this.handleVisibilityChange),window.addEventListener("beforeunload",this.handleUnload)},t.prototype.handleLoad=function(){var t=Date.now();this.updateCurTabStatus({activeTime:t,leaveTime:t}),this.heartbeat(),"visible"===document.visibilityState&&this.checkStatus(),this.report(o.ReportOnly,Date.now())},t.prototype.getUniqId=function(){return""+~~(1e9*Math.random())},t.prototype.getLogData=function(t,e){return Object.assign({action:t,status:"visible"===document.visibilityState?r.Active:r.Inactive,inactive_duration:Math.floor(e/1e3),tabinfo:this.getCurTabStatus()},this.defaultReportOptions)},t.prototype.updateTabCount=function(t){this.tabCount=t},t.prototype.suspend=function(){var t=this.listener.get(a.SuspendTab),e=this.options.canLeavePage;e?(e(),this.report(o.ReportOnly,Date.now()),this.handleUnload()):this.report(o.SuspendTab,Date.now()),t&&t.forEach((function(t){return t()})),this.updateCurTabStatus({suspended:!0})},t.prototype.updateCurTabStatus=function(t){var e=this.getTabStatus(this.id)||{};t.activeTime&&(e.activeTime=t.activeTime),t.leaveTime&&(e.leaveTime=t.leaveTime),t.suspended?t.suspended&&(e.suspended=!0):delete e.suspended,(e.activeTime||e.leaveTime)&&this.setTabStatus(this.id,e)},t.prototype.suspendTab=function(){var t,e=this;if("visible"!==document.visibilityState){var i=this.getAllTabStatus(),n=Object.keys(i);if(!(n.length-this.tabCountLimit<=0)){var s=this.id,a=null===(t=i[s])||void 0===t?void 0:t.leaveTime;if(!(Date.now()-a<this.suspendTabTimeLimit)){var r=!0;n.forEach((function(t){var n;if(t!==e.id){var s=i[t].leaveTime;if(s){var o=null===(n=i[t])||void 0===n?void 0:n.suspended;s<a&&o&&(r=!1)}}})),r&&(this.suspendTimer=setTimeout((function(){e.suspend()})))}}}},t.prototype.report=function(t,e){var i=this.getTabStatus(this.id);if(i){var n=i.leaveTime;if(n){var s=e-n;if(t===o.ReactivateTab&&n<this.reportReactivateTimeLimit)return;var a=this.getLogData(t,s);this.log(t,a)}}},t.prototype.heartbeat=function(){var t=this;this.updateTimer=setInterval((function(){t.updateCurTabStatus({activeTime:Date.now()}),t.getTabCount()>t.tabCountLimit&&t.suspendTab()}),this.beatTime)},t}(),d={visibilitychange:u,tabManager:new(function(){function t(t){var e=this;this.option=t,this.strategies=[],this.onMaxTab=function(){e.strategies.forEach((function(t){return t.release()}))}}return t.prototype.addStrategy=function(t){this.strategies.push(t)},t.prototype.start=function(t){this.init(t),this.tabStatusManager.addListener(a.SuspendTab,this.onMaxTab)},t.prototype.stop=function(){this.tabStatusManager&&this.tabStatusManager.removeListener(a.SuspendTab,this.onMaxTab)},t.prototype.init=function(t){var e=t.log||function(){};this.tabStatusManager||(this.tabStatusManager=new c(Object.assign({tabCountLimit:10,suspendTabTimeLimit:3e5,docId:t.docId,log:e},this.option)))},t}())};e.default=d}}).default}).call(this,i("../node_modules/webpack/buildin/global.js"))},"./src/external/fullMember/fullMember.ts":function(t,e,i){"use strict";i.r(e),function(t){i.d(e,"default",(function(){return v}));i("../node_modules/core-js/modules/es.array.concat.js");var n=i("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),s=i("../node_modules/@babel/runtime/helpers/esm/createClass.js"),a=i("../node_modules/axios/index.js"),r=i.n(a),o=i("../packages/report/src/index.ts"),u=i("./src/base/config/report.ts"),l=i("../packages/utils/src/safe.ts"),c=i("./src/base/error/errCodeType.ts"),d=i("./src/core/data/configService/spreadConfig.ts"),h=i("./src/base/index.ts"),p=i("./src/base/error/errorCodeModalProxy.ts"),b=i("../node_modules/@tencent/doc-visibilitychange/dist/tabkit.js"),f=i.n(b),v=function(){function e(t){var i=this;Object(n.a)(this,e),this.isFull=!1,this.isINACTIVE=!1,this.timer=0,this.fetchData=function(){o.b.monitor(33686980);var t=i.app.spreadsheet.activeSheetId,e="/dop-api/querydata?padid=".concat(d.a.getConfig("globalPadId"),"&type=sheet&subid=").concat(t);e+="&xsrf=".concat(Object(l.b)()),e+="&room=1",r()({method:"get",url:e,responseType:"json"}).catch((function(e){i.showFullMemberServerErrorTip(),o.b.run(u.CONFIG.FETCH_DATA_ERROR,[t,e])})).then((function(e){var n,s=null===e||void 0===e?void 0:e.data;s&&0===s.retcode?(i.clearServerErrorTip(),s.isOverConNum?i.app.event.spreadsheetEvent.trigger("syncLatestData",s.rev):i.turnOffFullMember()):(o.b.run(u.CONFIG.FETCH_DATA_ERROR_2,[t,null===s||void 0===s?void 0:s.retcode],s,null===s||void 0===s?void 0:s.retcode),null===(n=i.fullMemberTip)||void 0===n||n.close(),i.showFullMemberServerErrorTip())}))},this.app=t,this.startLoop=this.startLoop.bind(this),this.endLoop=this.endLoop.bind(this),this.fetchData=this.fetchData.bind(this),this.init()}return Object(s.a)(e,[{key:"init",value:function(){d.a.getConfig("isCreator")||d.a.getConfig("isOverConNum")&&!d.a.getConfig("isOverUpdateConNum")&&(o.b.monitor(33686979),this.turnOnFullMember(),f.a.visibilitychange.registerOnVisible(this.startLoop),f.a.visibilitychange.registerOnHidden(this.endLoop))}},{key:"turnOnFullMember",value:function(){var t=this;this.isFull=!0,0!=(2&d.a.getConfig("rightFlag"))&&(this.fullMemberTip||p.b.server.showFullMemberTip(c.a.FULL_MEMBER,(function(e){t.fullMemberTip=e})),this.app.permissions.activeTempStatus(!1),this.app.permissions.setWorkbookStatusFull(!0)),this.startLoop()}},{key:"startLoop",value:function(){var t=this;this.timer&&this.endLoop(),this.timer=setInterval((function(){t.fetchData()}),3e4)}},{key:"endLoop",value:function(){t.clearInterval(this.timer)}},{key:"turnOffFullMember",value:function(){var t,e,i;(this.isFull=!1,this.endLoop(),0!=(2&d.a.getConfig("rightFlag")))&&(null===(i=this.fullMemberTip)||void 0===i||i.close(),this.fullMemberTip=null,this.app.permissions.unactiveTempStatus(),this.app.permissions.setWorkbookStatusFull(!1));null===(t=this.app)||void 0===t||null===(e=t.socket)||void 0===e||e.reOpen(),f.a.visibilitychange.registerOnDestory(this.startLoop),f.a.visibilitychange.registerOnDestory(this.endLoop)}},{key:"setIsINACTIVE",value:function(t){this.isINACTIVE!==t&&(this.isINACTIVE=t,p.b.server.showFullMemberTipWithRefresh("INACTIVE"))}},{key:"showFullMemberServerErrorTip",value:function(){var t=this;this.clearServerErrorTip(),h.a.util.timer.wait(400).run((function(){p.b.server.showServerErrorTip(c.a.FULL_MEMBER,(function(e){t.fullMemberServerErrorTip=e}))}))}},{key:"clearServerErrorTip",value:function(){var t;null===(t=this.fullMemberServerErrorTip)||void 0===t||t.close(),this.fullMemberServerErrorTip=null}}]),e}()}.call(this,i("../node_modules/webpack/buildin/global.js"))}}]);
//# sourceMappingURL=pc-bundle_plugin_fullmember-56b2696237.js.map