(window.webpackJsonp=window.webpackJsonp||[]).push([["chunk_part4"],{"./src/core/network/datacenter/common/utils.ts":function(e,t,r){"use strict";r.d(t,"a",(function(){return n})),r.d(t,"b",(function(){return c}));var n,a=r("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=r("../node_modules/@tencent/docs-user-agent/dist/index.js"),o=r.n(s),i=r("../packages/report/src/index.ts");function c(e){var t,r=(t={},Object(a.a)(t,n.PRELOAD_CACHE,[35245212,35245211,35245210]),Object(a.a)(t,n.SECOND_SWITCH_CACHE,[35245215,35245214,35245213]),Object(a.a)(t,n.NO_CACHE,[35245218,35245217,35245216]),t);o.a.isMobilePhone?i.b.monitor(r[e][0]):o.a.isAndroidPad||o.a.isIPad?i.b.monitor(r[e][1]):i.b.monitor(r[e][2])}!function(e){e[e.PRELOAD_CACHE=0]="PRELOAD_CACHE",e[e.SECOND_SWITCH_CACHE=1]="SECOND_SWITCH_CACHE",e[e.NO_CACHE=2]="NO_CACHE"}(n||(n={}))},"./src/core/network/datacenter/datacenter.ts":function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return V})),r.d(t,"b",(function(){return x}));r("../node_modules/core-js/modules/es.symbol.js"),r("../node_modules/core-js/modules/es.array.concat.js"),r("../node_modules/core-js/modules/es.array.filter.js"),r("../node_modules/core-js/modules/es.array.for-each.js"),r("../node_modules/core-js/modules/es.array.index-of.js"),r("../node_modules/core-js/modules/es.array.iterator.js"),r("../node_modules/core-js/modules/es.array.map.js"),r("../node_modules/core-js/modules/es.array.slice.js"),r("../node_modules/core-js/modules/es.function.name.js"),r("../node_modules/core-js/modules/es.object.get-own-property-descriptor.js"),r("../node_modules/core-js/modules/es.object.get-own-property-descriptors.js"),r("../node_modules/core-js/modules/es.object.keys.js"),r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.promise.js"),r("../node_modules/core-js/modules/es.regexp.exec.js"),r("../node_modules/core-js/modules/es.string.iterator.js"),r("../node_modules/core-js/modules/es.string.replace.js"),r("../node_modules/core-js/modules/web.dom-collections.for-each.js"),r("../node_modules/core-js/modules/web.dom-collections.iterator.js");var n=r("../node_modules/@babel/runtime/helpers/esm/toConsumableArray.js"),a=r("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=(r("../node_modules/regenerator-runtime/runtime.js"),r("../node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js")),o=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),i=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),c=r("../node_modules/@babel/runtime/helpers/esm/typeof.js"),u=r("../packages/common-utils/src/url.ts"),l=r("./src/core/network/datacenter/loader/LoaderManager.ts"),d=r("./src/core/network/datacenter/loader/loaderUtil.ts"),h=r("./src/core/network/datacenter/serverDataManager.ts"),p=r("./src/core/network/datacenter/loader/loaderErrorType.ts"),f=r("./src/base/util/timer.ts"),_=r("./src/base/event/event.ts"),m=r("./src/core/data/converter/tencentdoc/keyframeToSheetConverter.ts"),b=r("../packages/mutation/src/other/InitDataMutation.ts"),v=r("./src/core/data/converter/tencentdoc/doMutation.ts"),g=r("./src/core/feature/formula/calcControllerTaskQueue.ts"),O=r("./src/core/network/datacenter/loader/blankpageUtil.ts"),k=r("../packages/common-utils/src/cookie.ts"),D=r("../packages/report/src/index.ts"),R=r("./src/base/config/report.ts"),E=r("../node_modules/lodash/flattenDeep.js"),I=r.n(E),y=r("./src/base/index.ts"),C=r("../node_modules/@tencent/docs-user-agent/dist/index.js"),j=r.n(C),S=r("./src/core/network/datacenter/common/utils.ts"),w=r("../node_modules/@tencent/docs_offline/lib/index.js"),A=r("./src/flow/utils.ts"),N=r("./src/base/error/errorCodeModalProxy.ts"),T=r("./src/core/network/datacenter/loader/automaticLogin.ts");function L(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function P(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?L(Object(r),!0).forEach((function(t){Object(a.a)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):L(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var x,F=function(e,t,r,n){var a,s=arguments.length,o=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"===("undefined"===typeof Reflect?"undefined":Object(c.a)(Reflect))&&"function"===typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var i=e.length-1;i>=0;i--)(a=e[i])&&(o=(s<3?a(o):s>3?a(t,r,o):a(t,r))||o);return s>3&&o&&Object.defineProperty(t,r,o),o},V=function(){function t(r){Object(o.a)(this,t),this.curChunk={},this.idleCallbackIds=[];var n=r.app,a=r.handleClientVars,s=r.getBaseVersion;this._containerID=e.containerID,this._getBaseVersion=s,this.app=n,this._init(),this.loaderManager=new l.a({handleClientVars:a})}return Object(i.a)(t,[{key:"destroy",value:function(){var t;null===(t=e.log)||void 0===t||t.debug("flow DataCenter destroy()"),this.loaderManager.destroy(),this.cancelIdleCallback(this.idleCallbackIds)}},{key:"handleLoadDocumentDataError",value:function(e){var t=e.error;if(t)switch(t.type){case p.b.OPEN_DOC_BLANK_PAGE_FORBIDDEN_RETRY:return Object(T.a)(e,t.data);case p.b.OPEN_DOC_BLANK_PAGE_ERROR_MAX_RETRY:case p.b.OPEN_DOC_NOT_200_ERROR_MAX_RETRY:case p.b.OPEN_DOC_AXIOS_ERROR:case p.b.OPEN_DOC_PAD_NO_EXIST:return Object(O.a)(3,t.data);case p.b.OPEN_DOC_JSON_PARSE_ERROR:return Object(O.a)(2);case p.b.OPEN_DOC_PAD_TYPE_ERROR:return location.replace(location.href.replace("/sheet/","/doc/"));case p.b.OPEN_DOC_ERROR_UNKNOWN:default:return Object(O.a)(1)}}},{key:"getIsNewDoc",value:function(){return"true"===Object(u.getQuery)("new",e.__originUrl)}},{key:"getTitle",value:function(){var t=Object(u.getQuery)("title",e.__originUrl);return t&&(t=decodeURIComponent(t)),t}},{key:"loadDocumentData",value:function(){var t=Object(s.a)(regeneratorRuntime.mark((function t(r){var n,a,s,o,i,c,l,_,m,b,v,g,O,D,R;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null===(n=e.log)||void 0===n||n.info("datacenter loadDocumentData",r),a=r.secretId,s=r.sheetId,o=this.getIsNewDoc(),"D0000000000000001"!==a&&!o){t.next=16;break}return i="D0000000000000001"===a?"300000000$A00000000001":"300000000$".concat(atob(a.substr(1))),c=this.getTitle(),l=Object(d.b)({globalPadId:i,secretId:a,uid:Object(k.getCookie)("uid"),title:c,isLocalNewFile:o}),Object(u.removeURLParameters)(location.href,["new","isShareme","folder","isOnlineBorrowed"]),(_=Object(h.c)(l)).setConfig({isNewDoc:o}),e.spreadConfig=_,e.clientVars=l,m={sheetId:s||"BB08J2",clientVars:l,spreadConfig:_,firstData:[[[]]],isFinished:!0},f.a.wait(0).run((function(){var e;null===(e=r.onSuccess)||void 0===e||e.call(r,{isSuccess:!0,startRow:0,endRow:0,chunkData:[[[]]],sheetId:s||"BB08J2",isFinished:!0})})),t.abrupt("return",m);case 16:return t.prev=16,t.next=19,this.loaderManager.loadDocumentData(r);case 19:if((O=t.sent).isSuccess&&!O.error){t.next=24;break}return null===(D=e.log)||void 0===D||D.error("datacenter.loadDocumentData() error",O),this.handleLoadDocumentDataError(O),t.abrupt("return",Promise.reject(x.LOAD_DOCUMENT_DATA_ERROR));case 24:return null===(b=e.log)||void 0===b||b.debug("flow DataCenter loadDocumentData response",O.spreadConfig,null===(v=O.loader)||void 0===v?void 0:v.name),null===(g=e.log)||void 0===g||g.info("loadDocumentData Success"),t.abrupt("return",O);case 29:return t.prev=29,t.t0=t.catch(16),null===(R=e.log)||void 0===R||R.error("flow DataCenter.loadDocumentData()",null===t.t0||void 0===t.t0?void 0:t.t0.stack),this.handleLoadError({sheetId:s||"BB08J2",code:"1",type:p.b.LOAD_ONLINE_DOCUMENT_DATA_FAIL,error:t.t0,message:"\u6570\u636e\u62c9\u53d6\u5931\u8d25"}),t.abrupt("return",Promise.reject("DataCenter.loadDocumentDataError"));case 34:case"end":return t.stop()}}),t,this,[[16,29]])})));return function(e){return t.apply(this,arguments)}}()},{key:"loadSheetData",value:function(){var t=Object(s.a)(regeneratorRuntime.mark((function t(r){var n,a,s,o,i,c,u,l=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null===(n=e.log)||void 0===n||n.info("flow DataCenter.loadSheetData()",r),a=+new Date,_.c.default.trigger("startLoadData",{sheetId:r.sheetId}),!(o=this.app.spreadsheet.sheetManager.getSheetBySheetId(r.sheetId)).isPreloading||r.isPreload){t.next=12;break}return Object(S.b)(S.a.PRELOAD_CACHE),this.app.view.canvas.dataCallView.stop(),y.a.event.spreadsheetEvent.remove("preloadFirstChunkEnd"),y.a.event.spreadsheetEvent.one("preloadFirstChunkEnd",(function(t){var r,n;o.getSheetId()===t&&(l.app.spreadsheet.activeSheetId=o.getSheetId(),null===(r=D.b.jank)||void 0===r||r.log({moduleValue:"SHEETS_BAR_JANK",actionValue:"SWITCH_SHEET"}),null===(n=e.log)||void 0===n||n.info("sheets_bar::switch_sheet_render_canvas_preload_first_chunk"),l.app.view.render(o.getSheetId()))})),y.a.event.spreadsheetEvent.remove("preloadSheetEnd"),y.a.event.spreadsheetEvent.one("preloadSheetEnd",(function(t){var n,a,s;o.getSheetId()===t&&(null===(n=D.b.jank)||void 0===n||n.log({moduleValue:"SHEETS_BAR_JANK",actionValue:"SWITCH_SHEET"}),null===(a=e.log)||void 0===a||a.info("sheets_bar::switch_sheet_render_canvas_preload_all_chunks"),l.app.view.render(t),null===r||void 0===r||null===(s=r.onSuccess)||void 0===s||s.call(r))})),t.abrupt("return");case 12:if(!r.ignoreLoader){t.next=17;break}return(null===(i=this._workerDataCache[r.sheetId])||void 0===i?void 0:i.isPreload)?(Object(S.b)(S.a.PRELOAD_CACHE),this._workerDataCache[r.sheetId].isPreload=!1):Object(S.b)(S.a.SECOND_SWITCH_CACHE),s={sheetId:r.sheetId,startRow:0,endRow:60,chunkData:[],isFinished:!0},this.applyChunkData(s,{switchSheetTimeStart:a,ignoreLoader:r.ignoreLoader,isPreload:r.isPreload,isSwitch:!r.isPreload,onFinished:function(){var e;null===(e=r.onSuccess)||void 0===e||e.call(r)}}),t.abrupt("return",s);case 17:return t.prev=17,null===o||void 0===o||o.startLoading(),r.isPreload&&o&&(o.isPreloading=!0),r.isPreload||Object(S.b)(S.a.NO_CACHE),t.next=23,this.loaderManager.loadSheetData(P(P({},r),{},{baseVersion:this._getBaseVersion(),onSuccess:function(e){l.applyChunkData(e,{switchSheetTimeStart:a,isPreload:r.isPreload,isSwitch:!r.isPreload,onFinished:function(){var e;null===(e=r.onSuccess)||void 0===e||e.call(r)}})},onFail:function(e){var t;e=e.error,null===(t=r.onFail)||void 0===t||t.call(r,e),l.handleLoadError({type:e.type,message:e.message,sheetId:r.sheetId,code:e.code})}}));case 23:s=t.sent,t.next=34;break;case 26:t.prev=26,t.t0=t.catch(17),null===o||void 0===o||o.stopLoading(!1),r.isPreload&&o&&(o.isPreloading=!1),u={sheetId:o.getSheetId(),type:p.b.LOAD_ONLINE_DOCUMENT_DATA_FAIL,code:"3",message:"loaderManager.loadSheetData catch error",error:t.t0},null===(c=r.onFail)||void 0===c||c.call(r,u),this.handleLoadError(u),console.error(t.t0);case 34:return t.abrupt("return",s);case 35:case"end":return t.stop()}}),t,this,[[17,26]])})));return function(e){return t.apply(this,arguments)}}()},{key:"preloadSheetsData",value:function(){var t=Object(s.a)(regeneratorRuntime.mark((function t(r){var a,s,o,i,u,l,d,h,p,f,_,m,b,v=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:null===(a=e.log)||void 0===a||a.info("flow DataCenter preloadSheetsData()",r),s=this.app.spreadsheet.sheetManager.getSheetIdList(),o=this.app.spreadsheet.getActiveSheetId(),i=s.indexOf(o),u=(null===r||void 0===r?void 0:r.leftCount)||1,l=(null===r||void 0===r?void 0:r.rightCount)||1,d=i-u>0?i-u:0,h=i+l+1,p=[].concat(Object(n.a)(s.slice(d,i)),Object(n.a)(s.slice(i+1,h))),f=regeneratorRuntime.mark((function t(r,n){var a,s,o,i;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(o=p[r],!(i=v.app.spreadsheet.sheetManager.getSheetBySheetId(o))||!i.isFetching&&!i.isLoaded){t.next=4;break}return t.abrupt("return",{v:void 0});case 4:return null===(a=D.b.jank)||void 0===a||a.log({moduleValue:"SHEETS_BAR_JANK",actionValue:"SWITCH_SHEET"}),null===(s=e.log)||void 0===s||s.info("sheets_bar::switch_sheet_load_data"),t.next=8,v.loadSheetData({sheetId:o,ignoreLoader:!1,isPreload:!0,onSuccess:function(){var e=Date.now(),t=(v.getWorkDataCache(o)||[[[]]]).map((function(e){return e.map((function(e){return v._handleMutation.bind(v,i,[[e]])}))}));v.callbackWhenIdle(I()(t),(function(){return v.app.spreadsheet.activeSheetId===o||Date.now()-e>=1e4}),(function(){return y.a.event.spreadsheetEvent.trigger("preloadFirstChunkEnd",o)}),(function(){y.a.event.spreadsheetEvent.trigger("preloadSheetEnd",o),v.handleLoadEnd(i,{isPreload:!0}),v.deleteWorkDatawCache(o)}))}});case 8:case"end":return t.stop()}}),t)})),_=0,m=p.length;case 11:if(!(_<m)){t.next=19;break}return t.delegateYield(f(_,m),"t0",13);case 13:if(b=t.t0,"object"!==Object(c.a)(b)){t.next=16;break}return t.abrupt("return",b.v);case 16:_++,t.next=11;break;case 19:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"callbackWhenIdle",value:function(t,r,n,a){for(var o=this,i=arguments.length,c=new Array(i>4?i-4:0),u=4;u<i;u++)c[u-4]=arguments[u];var l=this.idleCallbackIds.length,d=!1,h="function"===typeof t?[t]:t,p=!0,f=!j.a.isMobile&&e.requestIdleCallback||function(e){var t=Date.now();return setTimeout((function(){e({timeRemaining:function(){return Date.now()-t}})}),1)},_=function(){var e=Object(s.a)(regeneratorRuntime.mark((function e(t){var s,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=null===r||void 0===r?void 0:r(),!(t.timeRemaining()>45||s)){e.next=7;break}return e.next=5,null===(i=h.shift())||void 0===i?void 0:i.apply(o,c);case 5:p&&(null===n||void 0===n||n(),p=!1),d=!h.length;case 7:d?null===a||void 0===a||a():o.idleCallbackIds[l]=f(_);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();this.idleCallbackIds[l]=f(_)}},{key:"applyChunkData",value:function(){var t=Object(s.a)(regeneratorRuntime.mark((function t(r){var n,a,s,o,i,c,u,l,d,h,p,f,_=arguments;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=_.length>1&&void 0!==_[1]?_[1]:{},s=r.sheetId,o=a.ignoreLoader,i=a.isSwitch,c=a.isInit,u=a.onFinished,l=a.isPreload,d=a.switchSheetTimeStart,h=a.isLazy,p=this.app.spreadsheet.sheetManager.getSheetBySheetId(s)){t.next=7;break}return null===(f=e.log)||void 0===f||f.info("flow DataCenter.applyChunkData  sheet not found.",s,a),t.abrupt("return");case 7:if(l&&(null===(n=r.chunkData)||void 0===n?void 0:n.length)&&this.saveWorkDataCache(p.getSheetId(),r.chunkData,l),!l){t.next=11;break}return r.isFinished&&(null===u||void 0===u||u()),t.abrupt("return");case 11:if(0===r.startRow&&this.app.view.canvas.dataCallView.stop(),!h){t.next=17;break}return t.next=15,this._handleMutationLazy(p,r);case 15:t.next=18;break;case 17:this._handleMutation(p,r.chunkData);case 18:0===r.startRow&&(this.app.spreadsheet.activeSheetId=s,this.app.view.render(r.sheetId),D.b.speed.runReport(y.a.config.report.SPEED_REPORT_POINTS.SWITCH_SHEET_TIME,d,+new Date)),r.isFinished&&(this.handleLoadEnd(p,{ignoreLoader:o,isSwitch:i,isInit:c}),null===u||void 0===u||u());case 20:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"handleLoadEnd",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.ignoreLoader,n=t.isSwitch,a=t.isInit,s=t.isPreload,o=e.getSheetId();e.stopLoading(),e.isPreloading=!1,a||r?r&&this.triggerSetSheetInitializedForSwitchSheet(o):this.transformSheetInWorker(o),(n||s)&&_.c.default.trigger("afterLoadData",{sheetId:o});var i=function(){_.c.default.trigger("afterLoadDataInFormula",{sheetId:o})};this.app.calcController?i():Object(g.a)(i)}},{key:"transformSpreadsheet",value:function(e,t){var r=e.getSheetId();return Object(m.a)(this.app.spreadsheet,r,t),this.transformSheetInWorker(r),e}},{key:"afterCopySheetData",value:function(e,t){var r=this.app.spreadsheet.sheetManager.getSheetBySheetId(e),n=this.app.spreadsheet.sheetManager.getSheetBySheetId(t);if(r&&n){var a=new b.a({sheetId:r.getSheetId(),lastRow:r.getRowCount()-1,lastCol:r.getColCount()-1});n.spreadsheetReference.parent.mutationBehavior.applyMutation(a,{isLocal:!0},r)}}},{key:"saveDataCache",value:function(e,t){this._dataCache[e]||(this._dataCache[e]=[]),this._dataCache[e].push(t)}},{key:"deleteDataCache",value:function(e){this._dataCache[e]&&(this._dataCache[e].length=0),delete this._dataCache[e]}},{key:"getDataCache",value:function(e){return this._dataCache[e]}},{key:"getWorkDataCache",value:function(e){return this._workerDataCache[e].data}},{key:"saveWorkDataCache",value:function(e,t,r){this._workerDataCache[e]||(this._workerDataCache[e]={data:[],isPreload:!!r}),t&&(this._workerDataCache[e].data=this._workerDataCache[e].data.concat(t))}},{key:"deleteWorkDatawCache",value:function(e){var t;return(null===(t=this._workerDataCache[e])||void 0===t?void 0:t.data)&&(this._workerDataCache[e].data.length=0),delete this._workerDataCache[e]}},{key:"handleLoadError",value:function(e){switch(_.c.default.trigger("afterLoadData",{sheetId:e.sheetId}),e.type){case p.b.LOAD_ONLINE_DOCUMENT_DATA_FAIL:this.handleErrorCode("D",e.code),D.b.monitor(34871108);break;case p.b.LOAD_ONLINE_SHEET_DATA_FAIL:this.handleErrorCode("C",e.code),D.b.monitor(33701441);break;case p.b.LOAD_ONLINE_SHEET_DATA_CATCH_ERROR:D.b.monitor(34871107);break;case p.b.LOAD_OFFLINE_DOCUMENT_DATA_FAIL:case p.b.LOAD_OFFLINE_CHUNK_DATA_FAIL:case p.b.LOAD_OFFLINE_SHEET_DATA_FAIL:break;case p.b.LOAD_OFFLINE_VERSION_DATA_NULL:D.b.run(R.CONFIG.LOAD_OFFLINE_VERSION_DATA_NULL);break;case p.b.LOAD_OFFLINE_VERSION_DATA_INVALID:D.b.run(R.CONFIG.LOAD_OFFLINE_VERSION_DATA_INVALID),w.OfflineAPI.clearDocumentCache(location.pathname.replace("/sheet/",""),Object(k.getCookie)("uid"))}D.b.run(R.CONFIG.LOAD_ERROR,e.type,[e.sheetId,e.message,e.error])}},{key:"handleErrorCode",value:function(t,r){switch(r){case"1":try{var n,a;null===(n=e)||void 0===n||null===(a=n.localStorage)||void 0===a||a.clear()}catch(s){console.error("\u6e05\u9664localStorage\u5931\u8d25",s)}N.b.server.showRefreshTips("".concat(t,"-").concat(r),"\u65e0\u6cd5\u52a0\u8f7d\u8868\u683c\uff0c\u6211\u4eec\u5bf9\u6b64\u5f15\u8d77\u7684\u4e0d\u4fbf\u8868\u793a\u62b1\u6b49\uff0c\u4f60\u53ef\u4ee5\u5c1d\u8bd5\u5237\u65b0\u91cd\u8bd5\u6216\u53cd\u9988\uff0c\u5e2e\u52a9\u6211\u4eec\u6539\u5584\u4f53\u9a8c\u3002",!0);break;case"100000":N.b.client.showLoginExpiredTip("".concat(t,"-").concat(r));break;case"100003":N.b.server.showRefreshTips("".concat(t,"-").concat(r),"\u670d\u52a1\u5f02\u5e38\uff0c\u6211\u4eec\u5bf9\u6b64\u5f15\u8d77\u7684\u4e0d\u4fbf\u8868\u793a\u62b1\u6b49\uff0c\u4f60\u53ef\u4ee5\u5c1d\u8bd5\u5237\u65b0\u91cd\u8bd5\u6216\u53cd\u9988\uff0c\u5e2e\u52a9\u6211\u4eec\u6539\u5584\u4f53\u9a8c\u3002",!0);break;case"100010":N.b.server.showRefreshTips("".concat(t,"-").concat(r),"Refer\u6765\u6e90\u53d1\u751f\u53d8\u5316\uff0c\u8bf7\u68c0\u67e5\u8bf7\u6c42\u6765\u6e90\u3002");break;case"100012":N.b.server.showRefreshTips("".concat(t,"-").concat(r),"\u670d\u52a1\u8d85\u65f6\uff0c\u6211\u4eec\u5bf9\u6b64\u5f15\u8d77\u7684\u4e0d\u4fbf\u8868\u793a\u62b1\u6b49\uff0c\u4f60\u53ef\u4ee5\u5c1d\u8bd5\u5237\u65b0\u91cd\u8bd5\u6216\u53cd\u9988\uff0c\u5e2e\u52a9\u6211\u4eec\u6539\u5584\u4f53\u9a8c\u3002",!0);break;case"111111":N.b.server.showRefreshTips("".concat(t,"-").concat(r),"\u672a\u77e5\u9519\u8bef\uff0c\u6211\u4eec\u5bf9\u6b64\u5f15\u8d77\u7684\u4e0d\u4fbf\u8868\u793a\u62b1\u6b49\uff0c\u4f60\u53ef\u4ee5\u5c1d\u8bd5\u5237\u65b0\u91cd\u8bd5\u6216\u53cd\u9988\uff0c\u5e2e\u52a9\u6211\u4eec\u6539\u5584\u4f53\u9a8c\u3002",!0);break;case"200026":N.b.server.showRefreshTips("".concat(t,"-").concat(r),"\u6587\u6863\u4fe1\u606f\u67e5\u8be2\u5931\u8d25\uff0c\u6211\u4eec\u5bf9\u6b64\u5f15\u8d77\u7684\u4e0d\u4fbf\u8868\u793a\u62b1\u6b49\uff0c\u4f60\u53ef\u4ee5\u5c1d\u8bd5\u5237\u65b0\u91cd\u8bd5\u6216\u53cd\u9988\uff0c\u5e2e\u52a9\u6211\u4eec\u6539\u5584\u4f53\u9a8c\u3002",!0);break;case"200040":N.b.server.showRefreshTips("".concat(t,"-").concat(r),"\u65e0\u6cd5\u52a0\u8f7d\u8868\u683c\uff0c\u6211\u4eec\u5bf9\u6b64\u5f15\u8d77\u7684\u4e0d\u4fbf\u8868\u793a\u62b1\u6b49\uff0c\u4f60\u53ef\u4ee5\u5c1d\u8bd5\u5237\u65b0\u91cd\u8bd5\u6216\u53cd\u9988\uff0c\u5e2e\u52a9\u6211\u4eec\u6539\u5584\u4f53\u9a8c\u3002",!0);break;case"200105":case"200700":N.b.client.showLoginExpiredTip("".concat(t,"-").concat(r));break;case"200109":N.b.server.showFileDeletedTip("".concat(t,"-").concat(r));break;default:N.b.server.showRefreshTips("".concat(t,"-").concat(r||"000"),"\u65e0\u6cd5\u52a0\u8f7d\u8868\u683c\uff0c\u6211\u4eec\u5bf9\u6b64\u5f15\u8d77\u7684\u4e0d\u4fbf\u8868\u793a\u62b1\u6b49\uff0c\u4f60\u53ef\u4ee5\u5c1d\u8bd5\u5237\u65b0\u91cd\u8bd5\u6216\u53cd\u9988\uff0c\u5e2e\u52a9\u6211\u4eec\u6539\u5584\u4f53\u9a8c\u3002",!0)}}},{key:"cancelIdleCallback",value:function(t){!j.a.isMobile&&e.cancelIdleCallback?t.forEach((function(t){e.cancelIdleCallback(t)})):t.forEach((function(e){clearTimeout(e)}))}},{key:"triggerSetSheetInitializedForSwitchSheet",value:function(e){var t=function(){_.c.default.trigger("setSheetInitializedForSwitchSheet",{sheetId:e})};this.app.calcController?t():Object(g.a)(t)}},{key:"_init",value:function(){this._dataCache={},this._workerDataCache={}}},{key:"transformSheetInWorker",value:function(e){(0,this.app.getCurrentMainThreadWorker().loadSheetToWorkerIfNeeded)(e)||this.triggerSetSheetInitializedForSwitchSheet(e)}},{key:"_handleMutation",value:function(t,r,n){var a;if(Array.isArray(r))for(var s=0;s<r.length;s++)for(var o=r[s],i=0;i<o.length;i++)Object(v.a)(this.app.spreadsheet,o[i],(function(e){"function"===typeof n&&n(e)}));else null===(a=e.log)||void 0===a||a.error("flow DataCenter._handleMutation()  mutationss is not array",r)}},{key:"_handleMutationLazy",value:function(e,t,r){var n=this,a=t.sheetId;this.curChunk[a]=this.curChunk[a]?this.curChunk[a]+1:1;var s=this.app.lifeCycle===SpreadsheetApp.EVENT.PAGE_LOAD_FINISHED?0:1500+300*this.curChunk[a];return new Promise((function(a){f.a.wait(s).run((function(){n._handleMutation(e,t.chunkData,r),a()}))}))}},{key:"containerID",get:function(){return this._containerID}}]),t}();V=F([Object(A.a)("M_DataCenter")],V),function(e){e.LOAD_DOCUMENT_DATA_ERROR="LOAD_DOCUMENT_DATA_ERROR"}(x||(x={}))}).call(this,r("../node_modules/webpack/buildin/global.js"))},"./src/core/network/datacenter/loader/Loader.ts":function(e,t,r){"use strict";(function(e){r.d(t,"b",(function(){return a})),r.d(t,"a",(function(){return l}));r("../node_modules/core-js/modules/es.function.name.js");var n,a,s,o=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),i=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),c=r("../packages/report/src/index.ts"),u=r("./src/base/config/report.ts");!function(e){e.INIT="INIT",e.WORKING="WORKING",e.PAUSED="PAUSED"}(n||(n={})),function(e){e.OFFLINE="OFFLINE",e.SERVER="SERVER"}(a||(a={})),function(e){e.FAIL="FAIL",e.SUCCESS="SUCCESS"}(s||(s={}));var l=function(){function t(r){Object(o.a)(this,t),this.status=n.INIT,this.name=r.name,this.handleClientVars=r.handleClientVars,this._containerID=e.containerID}return Object(i.a)(t,[{key:"pause",value:function(){c.b.run(u.CONFIG.PAUSE_LOADER,[this._containerID,this.name]),this.status=n.PAUSED}},{key:"work",value:function(){c.b.run(u.CONFIG.WORK_LOADER,[this._containerID,this.name]),this.status=n.WORKING}},{key:"isPause",value:function(){return this.status===n.PAUSED}}]),t}()}).call(this,r("../node_modules/webpack/buildin/global.js"))},"./src/core/network/datacenter/loader/LoaderManager.ts":function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return u}));r("../node_modules/core-js/modules/es.array.for-each.js"),r("../node_modules/core-js/modules/es.function.name.js"),r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.promise.js"),r("../node_modules/core-js/modules/web.dom-collections.for-each.js"),r("../node_modules/regenerator-runtime/runtime.js");var n=r("../node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js"),a=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),s=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),o=r("./src/core/network/datacenter/loader/ServerLoader.ts"),i=r("./src/core/network/datacenter/loader/OfflineLoader.ts"),c=r("./src/core/network/datacenter/loader/Loader.ts"),u=function(){function t(e){Object(a.a)(this,t),this.loaders=[],this.errorLoaderCount=0;var r=e.handleClientVars;this.serverLoader=new o.a({name:c.b.SERVER,handleClientVars:r}),this.offlineLoader=new i.a({name:c.b.OFFLINE,handleClientVars:r}),window.__SUPPORT_FULL_OFFLINE_MODE&&this.loaders.push(this.offlineLoader),this.loaders.push(this.serverLoader),this._init()}return Object(s.a)(t,[{key:"getLoader",value:function(e){for(var t=0;t<this.loaders.length;t++)if(this.loaders[t].name===e)return this.loaders[t]}},{key:"destroy",value:function(){this._init(),this.serverLoader.destroy(),this.serverLoader.destroy()}},{key:"loadDocumentData",value:function(){var e=Object(n.a)(regeneratorRuntime.mark((function e(t){var r=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=Object(n.a)(regeneratorRuntime.mark((function e(n,a){var s,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(s=r.loaders.length,0,o=0;o<s;o++)r.loaders[o].loadDocumentData(t).then((function(e){if(e.isSuccess)return r.firstSuccessComeBackLoader||(r.firstSuccessComeBackLoader=e.loader),r._pauseOtherLoader(),n(e);if(e.loader&&(r.temp[e.loader.name]=e),r.errorLoaderCount+=1,r.errorLoaderCount===r.loaders.length){var t=r._getPrioritizedLoader().name;return n(r.temp[t])}})).catch((function(e){a(e)}));case 3:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"loadSheetData",value:function(){var t=Object(n.a)(regeneratorRuntime.mark((function t(r){var n,a=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return null===(n=e.log)||void 0===n||n.info("LoaderManager.loadSheetData()",r),this._resetFirstSuccessComeBackLoader(),t.abrupt("return",new Promise((function(e,t){for(var n=0;n<a.loaders.length;n++)a.loaders[n].loadSheetData(r).then((function(t){if(t.isSuccess)return a.firstSuccessComeBackLoader||(a.firstSuccessComeBackLoader=t.loader),a._pauseOtherLoader(),e(t)}))})));case 3:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"_init",value:function(){this.temp={},this.errorLoaderCount=0,this.firstSuccessComeBackLoader=void 0}},{key:"_pauseOtherLoader",value:function(){if(this.firstSuccessComeBackLoader){var e=this.firstSuccessComeBackLoader.name;this.loaders.forEach((function(t){t.name!==e&&t.pause()}))}}},{key:"_getPrioritizedLoader",value:function(){return this.serverLoader}},{key:"_resetFirstSuccessComeBackLoader",value:function(){this.firstSuccessComeBackLoader=void 0}}]),t}()}).call(this,r("../node_modules/webpack/buildin/global.js"))},"./src/core/network/datacenter/loader/OfflineLoader.ts":function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return f}));r("../node_modules/core-js/modules/es.array.concat.js"),r("../node_modules/core-js/modules/es.array.for-each.js"),r("../node_modules/core-js/modules/es.array.map.js"),r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.promise.js"),r("../node_modules/core-js/modules/es.reflect.construct.js"),r("../node_modules/core-js/modules/es.regexp.exec.js"),r("../node_modules/core-js/modules/es.regexp.to-string.js"),r("../node_modules/core-js/modules/es.string.replace.js"),r("../node_modules/core-js/modules/web.dom-collections.for-each.js"),r("../node_modules/regenerator-runtime/runtime.js");var n=r("../node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js"),a=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),s=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),o=r("../node_modules/@babel/runtime/helpers/esm/inherits.js"),i=r("../node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn.js"),c=r("../node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js"),u=r("./src/core/network/datacenter/loader/Loader.ts"),l=r("../node_modules/@tencent/docs_offline/lib/index.js"),d=r("./src/core/network/datacenter/loader/loaderErrorType.ts"),h=r("./src/core/network/datacenter/serverDataManager.ts");function p(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=Object(c.a)(e);if(t){var a=Object(c.a)(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Object(i.a)(this,r)}}var f=function(t){Object(o.a)(i,t);var r=p(i);function i(e){var t;return Object(a.a)(this,i),(t=r.call(this,e)).priority=1,t}return Object(s.a)(i,[{key:"destroy",value:function(){this._init()}},{key:"loadDocumentData",value:function(){var t=Object(n.a)(regeneratorRuntime.mark((function t(r){var a=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.work(),t.abrupt("return",new Promise(function(){var t=Object(n.a)(regeneratorRuntime.mark((function t(n,s){var o;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:null===(o=e.log)||void 0===o||o.info("".concat(a._containerID,"offlineLoader \u8bf7\u6c42 \u79bb\u7ebf \u9996\u5c4f\u6570\u636e")),l.OfflineAPI.loadDocumentData({id:r.secretId,subId:r.sheetId,onSuccess:function(e){a._loadDocumentDataSuccess(e,n,r)},onFail:function(e){a._loadDocumentDataFail(n,e)}});case 2:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}()));case 2:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"loadSheetData",value:function(){var t=Object(n.a)(regeneratorRuntime.mark((function t(r){var a=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.work(),t.abrupt("return",new Promise(function(){var t=Object(n.a)(regeneratorRuntime.mark((function t(n,s){var o,i;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:null===(o=e.log)||void 0===o||o.info("".concat(a._containerID,"offlineLoader \u5207\u8868\uff0c\u8bf7\u6c42\u79bb\u7ebf\u6570\u636e"),r),i=location.pathname.replace("/sheet/",""),l.OfflineAPI.loadSubDocumentData({subId:r.sheetId,baseVersion:r.baseVersion,id:i,onSuccess:function(e){a._loadSheetDataSuccess(e,n,s,r)},onFail:function(e){a._loadSheetDataFail(n,e,r)}});case 3:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}()));case 2:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"_loadDocumentDataSuccess",value:function(t,r,n){var a,s,o=t.dataType;if(null===(a=e.log)||void 0===a||a.info("".concat(this._containerID,"offlineLoader loadDocumentData success"),o),this.isPause())null===(s=e.log)||void 0===s||s.info("loader time \u79bb\u7ebf ".concat(o," \u6570\u636e\u88ab\u629b\u5f03"));else switch(o){case l.DATA_TYPE.SNAP_SHOT:return this._handleSnapShot(t,r);case l.DATA_TYPE.CHUNK:return this._handleChunkData(t,n,r);case l.DATA_TYPE.VERSION_DATA:return this._handleVersionData(t,n,!1,r);default:return}}},{key:"_loadDocumentDataFail",value:function(t,r){var n;null===(n=e.log)||void 0===n||n.error("loadDocumentData() error. ",r),t({isSuccess:!1,error:{type:d.b.LOAD_OFFLINE_DOCUMENT_DATA_FAIL,message:"offlineLoader \u8bf7\u6c42 \u79bb\u7ebf \u5931\u8d25"},loader:this})}},{key:"_loadSheetDataSuccess",value:function(){var t=Object(n.a)(regeneratorRuntime.mark((function t(r,n,a,s){var o;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:null===(o=e.log)||void 0===o||o.info("".concat(this._containerID,"offlineLoader \u5207\u8868\uff0c\u8bf7\u6c42\u79bb\u7ebf\u6570\u636e\u8fd4\u56de\u4e86"),s.sheetId),t.t0=r.dataType,t.next=t.t0===l.DATA_TYPE.SNAP_SHOT?4:t.t0===l.DATA_TYPE.VERSION_DATA?5:6;break;case 4:return t.abrupt("return",this._handleSheetSnapShot(r,s,n,a));case 5:return t.abrupt("return",this._handleVersionData(r,s,!0,n));case 6:return t.abrupt("return");case 7:case"end":return t.stop()}}),t,this)})));return function(e,r,n,a){return t.apply(this,arguments)}}()},{key:"_loadSheetDataFail",value:function(t,r,n){var a;null===(a=e.log)||void 0===a||a.info("".concat(this._containerID,"offlineLoader  \u5207\u8868\u8bf7\u6c42 \u79bb\u7ebf sheet \u6570\u636e\u5931\u8d25 ")),t({isSuccess:!1,error:{type:d.b.LOAD_OFFLINE_SHEET_DATA_FAIL,message:"\u8bf7\u6c42 \u79bb\u7ebf sheet \u6570\u636e\u5931\u8d25",sheetId:n.sheetId},loader:this})}},{key:"_init",value:function(){}},{key:"_handleSnapShot",value:function(t,r){var n,a,s,o,i=t.clientVars,c=t.workbookData,u=t.chunkData,l=t.subId,p=t.isFinished;if(null===(n=e.log)||void 0===n||n.info("".concat(this._containerID,"offlineLoader  \u79bb\u7ebf \u8fd4\u56de\u9996\u5c4f\u6570\u636e"),l,p),!i||!c||!u)return null===(o=e.log)||void 0===o||o.info("".concat(this._containerID,"offlineLoader \u79bb\u7ebf\u9996\u5c4f\u6570\u636e\u4e3a\u7a7a\uff0c"),l,p),this.pause(),r({isSuccess:!1,error:{type:d.b.LOAD_OFFLINE_DOCUMENT_DATA_FAIL,message:"\u79bb\u7ebf\u9996\u5c4f\u6570\u636e\u4e3a\u7a7a\uff0c"},loader:this});var f=Object(h.b)(i);null===(a=this.handleClientVars)||void 0===a||a.call(this,i,f);var _=[c.data,u.data];return null===(s=e.log)||void 0===s||s.info("".concat(this._containerID,"offlineLoader \u79bb\u7ebf\u9996\u5c4f\u6570\u636e\u8fd4\u56de\u7ed9\u4e0a\u5c42"),l,p),r({spreadConfig:f,clientVars:i,firstData:_,sheetId:l,isFinished:!1,loader:this,isSuccess:!0})}},{key:"_handleChunkData",value:function(){var t=Object(n.a)(regeneratorRuntime.mark((function t(r,n,a){var s,o,i,c,u,l,h,p;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r.dataType,r.clientVars,r.workbookData,c=r.chunkData,u=r.subId,l=r.isFinished,null===(s=e.log)||void 0===s||s.info("".concat(this._containerID,"offlineLoader  \u79bb\u7ebf \u8fd4\u56de\u5206\u7247\u6570\u636e"),u,l),c&&c.data){t.next=6;break}return null===(h=e.log)||void 0===h||h.error("offlineLoader > \u79bb\u7ebf\u5206\u7247\u6570\u636e\u4e3a\u7a7a"),null===(p=n.onFail)||void 0===p||p.call(n,{isSuccess:!1,error:{type:d.b.LOAD_OFFLINE_CHUNK_DATA_FAIL,message:"\u79bb\u7ebf\u5206\u7247\u6570\u636e\u4e3a\u7a7a"}}),t.abrupt("return");case 6:return null===(o=e.log)||void 0===o||o.info("".concat(this._containerID,"offlineLoader  \u79bb\u7ebf \u5206\u7247\u6570\u636e\u8fd4\u56de\u7ed9\u4e0a\u5c42"),u),t.next=9,null===(i=n.onSuccess)||void 0===i?void 0:i.call(n,{isSuccess:!0,chunkData:[c.data],sheetId:u,isFinished:l});case 9:null===a||void 0===a||a();case 10:case"end":return t.stop()}}),t,this)})));return function(e,r,n){return t.apply(this,arguments)}}()},{key:"_isWorkbookMutation",value:function(e){for(var t=e.length,r=0;r<t;r++)for(var n=e[r].length,a=0;a<n;a++){var s=e[r][a].r;if(s>=45&&s<=58)return!0}return!1}},{key:"_handleVersionData",value:function(){var t=Object(n.a)(regeneratorRuntime.mark((function t(r,n){var a,s,o,i,c,u,l,h,p,f,_,m,b,v,g,O=this,k=arguments;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(c=k.length>2&&void 0!==k[2]&&k[2],u=k.length>3?k[3]:void 0,r.dataType,l=r.chunkData,h=r.isFinished,p=r.subId,null===(a=e.log)||void 0===a||a.info("".concat(this._containerID,"offlineLoader  \u79bb\u7ebf \u8fd4\u56de\u7248\u672c\u6570\u636e"),p,h),l){t.next=8;break}return null===(f=e.log)||void 0===f||f.error("offlineLoader >  \u79bb\u7ebf \u7248\u672c\u6570\u636e\u5f02\u5e38"),null===(_=n.onFail)||void 0===_||_.call(n,{isSuccess:!1,error:{type:d.b.LOAD_OFFLINE_VERSION_DATA_NULL,message:"\u79bb\u7ebf \u7248\u672c\u6570\u636e\u5f02\u5e38"}}),t.abrupt("return",null===u||void 0===u?void 0:u());case 8:if(null===(s=e.log)||void 0===s||s.info("".concat(this._containerID,"offlineLoader  \u79bb\u7ebf \u7248\u672c\u6570\u636e\u8fd4\u56de\u7ed9\u4e0a\u5c42 chunkData.length=").concat(l.length)),m=l.map((function(e){if(c){if(e.subId===p&&!O._isWorkbookMutation(e.data))return e.data}else if(e.subId===p||O._isWorkbookMutation(e.data))return e.data;return[[]]})),b=l.map((function(e){return e.version})),null===(o=e.log)||void 0===o||o.info("".concat(this._containerID,"offlineLoader  \u79bb\u7ebf \u8fd4\u56de\u7248\u672c\u6570\u636e\u4e3a"),b,p,n.sheetId),c||this.isVersionDataValid(b)){t.next=16;break}return null===(v=e.log)||void 0===v||v.info("\u589e\u91cf\u6570\u636e\u7248\u672c\u4e0d\u8fde\u7eed\uff0c\u9700\u8981\u6e05\u6389\u79bb\u7ebf\u6570\u636e\uff0c\u63d0\u793a\u7528\u6237\uff0c\u8d70\u5728\u7ebf\u903b\u8f91\u3002"),null===(g=n.onFail)||void 0===g||g.call(n,{isSuccess:!1,error:{type:d.b.LOAD_OFFLINE_VERSION_DATA_INVALID,message:"\u79bb\u7ebf \u7248\u672c\u6570\u636e\u5f02\u5e38",code:"O00001"}}),t.abrupt("return",null===u||void 0===u?void 0:u());case 16:return t.next=18,null===(i=n.onSuccess)||void 0===i?void 0:i.call(n,{isSuccess:!0,chunkData:m,isFinished:h,sheetId:p});case 18:null===u||void 0===u||u();case 19:case"end":return t.stop()}}),t,this)})));return function(e,r){return t.apply(this,arguments)}}()},{key:"isVersionDataValid",value:function(e){if(!e.length)return!0;var t=e.sort((function(e,t){return e-t})),r=t.length,n=t[0];return t[r-1]-n+1===r}},{key:"_handleSheetSnapShot",value:function(t,r,n,a){var s,o,i=t.chunkData,c=t.isFinished;if(this.isPause()){var u;null===(u=e.log)||void 0===u||u.info("".concat(this._containerID," offlineLoader \u5207\u8868\uff0c\u8bf7\u6c42\u7684\u79bb\u7ebf\u6570\u636e\u6570\u636e\u88ab\u629b\u5f03"),r.sheetId)}else{var l={startRow:0,isSuccess:!0,sheetId:r.sheetId,chunkData:[],isFinished:c,loader:this};i.forEach((function(e){l.chunkData.push(e.data.data||[[]])})),null===(s=e.log)||void 0===s||s.info("".concat(this._containerID," offlineLoader \u5207\u8868\uff0c\u8bf7\u6c42\u79bb\u7ebf\u6570\u636e\u8fd4\u56de\u7ed9 LoaderManager"),r.sheetId,c),n(l),null===(o=r.onSuccess)||void 0===o||o.call(r,l)}}}]),i}(u.a);f.priority=1}).call(this,r("../node_modules/webpack/buildin/global.js"))},"./src/core/network/datacenter/loader/ServerLoader.ts":function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return y}));r("../node_modules/core-js/modules/es.symbol.js"),r("../node_modules/core-js/modules/es.array.concat.js"),r("../node_modules/core-js/modules/es.array.filter.js"),r("../node_modules/core-js/modules/es.array.for-each.js"),r("../node_modules/core-js/modules/es.array.index-of.js"),r("../node_modules/core-js/modules/es.array.iterator.js"),r("../node_modules/core-js/modules/es.function.name.js"),r("../node_modules/core-js/modules/es.number.constructor.js"),r("../node_modules/core-js/modules/es.object.get-own-property-descriptor.js"),r("../node_modules/core-js/modules/es.object.get-own-property-descriptors.js"),r("../node_modules/core-js/modules/es.object.keys.js"),r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.promise.js"),r("../node_modules/core-js/modules/es.reflect.construct.js"),r("../node_modules/core-js/modules/es.regexp.exec.js"),r("../node_modules/core-js/modules/es.regexp.to-string.js"),r("../node_modules/core-js/modules/es.string.iterator.js"),r("../node_modules/core-js/modules/es.string.replace.js"),r("../node_modules/core-js/modules/es.string.search.js"),r("../node_modules/core-js/modules/web.dom-collections.for-each.js"),r("../node_modules/core-js/modules/web.dom-collections.iterator.js");var n=r("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),a=(r("../node_modules/regenerator-runtime/runtime.js"),r("../node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js")),s=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),o=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),i=r("../node_modules/@babel/runtime/helpers/esm/inherits.js"),c=r("../node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn.js"),u=r("../node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js"),l=r("../node_modules/axios/index.js"),d=r.n(l),h=r("./src/core/network/datacenter/loader/Loader.ts"),p=r("../packages/common-utils/src/cookie.ts"),f=r("../packages/utils/src/safe.ts"),_=r("./src/core/network/datacenter/loader/loaderUtil.ts"),m=r("./src/core/network/datacenter/loader/loaderErrorType.ts"),b=r("./src/core/network/datacenter/serverDataManager.ts"),v=r("./src/core/data/configService/spreadConfig.ts"),g=r("../packages/report/src/index.ts"),O=r("./src/base/config/report.ts"),k=r("../packages/common-utils/src/url.ts"),D=r("../packages/model/src/config/index.ts");function R(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function E(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?R(Object(r),!0).forEach((function(t){Object(n.a)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):R(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function I(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=Object(u.a)(e);if(t){var a=Object(u.a)(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Object(c.a)(this,r)}}var y=function(t){Object(i.a)(n,t);var r=I(n);function n(e){var t;return Object(s.a)(this,n),(t=r.call(this,e)).slicedRowCount={},t.openDocRetryTimes=3,t.priority=0,t.from=D.DEFAULT_FIRST_CHUNK_START_ROW,t.count=D.DEFAULT_FIRST_CHUNK_END_ROW,t.firstDataRowCount=60,t.retryFetchChunkTime=0,t._init(),t}return Object(o.a)(n,[{key:"destroy",value:function(){this._init()}},{key:"loadDocumentData",value:function(){var t=Object(a.a)(regeneratorRuntime.mark((function t(r){var n=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.work(),t.abrupt("return",new Promise(function(){var t=Object(a.a)(regeneratorRuntime.mark((function t(a,s){var o,i,c,u,l;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(o=e.openDocResponseText,c=(i=e).openDocType,u=i.openDocXhr,"JSONP"!==c){t.next=8;break}if(void 0===o){t.next=6;break}return g.b.run(O.CONFIG.SERVER_LOADER_OPEN_DOC_ORIGIN_TYPE,"openDocInlineData",[n._containerID,r.sheetId,n.from,n.count,o]),t.abrupt("return",n.handleOpenDocResponseJSONP(o,a,s,r));case 6:t.next=14;break;case 8:if(!u||void 0===o){t.next=11;break}return g.b.run(O.CONFIG.SERVER_LOADER_OPEN_DOC_ORIGIN_TYPE,"openDocInlineData",[n._containerID,r.sheetId,n.from,n.count,o]),t.abrupt("return",n._handleOpenDocResponse(u,o,a,s,r));case 11:if(!u||void 0!==o){t.next=14;break}return g.b.run(O.CONFIG.SERVER_LOADER_OPEN_DOC_ORIGIN_TYPE,"openDocInlineButNoData",[n._containerID,r.sheetId,n.from,n.count,o]),t.abrupt("return",n._overWriteXhrReadyStateChange(u,a,s,r));case 14:return g.b.run(O.CONFIG.SERVER_LOADER_OPEN_DOC_ORIGIN_TYPE,"openDocServerLoaderData",[n._containerID,r.sheetId,n.from,n.count,o]),t.prev=15,t.next=18,n._fetchOpenDoc(r);case 18:l=t.sent,t.next=25;break;case 21:return t.prev=21,t.t0=t.catch(15),g.b.run(O.CONFIG.LOADER,"fetchOpenDocError",[n._containerID,r.sheetId,n.from,n.count,null===t.t0||void 0===t.t0?void 0:t.t0.stack]),t.abrupt("return",a({isSuccess:!1,error:{type:m.b.OPEN_DOC_AXIOS_ERROR,message:null===t.t0||void 0===t.t0?void 0:t.t0.message},loader:n}));case 25:return t.abrupt("return",n._handleOpenDocResponse(l,l.data,a,s,r));case 26:case"end":return t.stop()}}),t,null,[[15,21]])})));return function(e,r){return t.apply(this,arguments)}}()).then(function(){var t=Object(a.a)(regeneratorRuntime.mark((function t(a){var s,o,i,c,u,l,d,h;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(delete e.openDocType,delete e.openDocXhr,delete e.openDocResponseText,a.isSuccess&&!a.error){t.next=5;break}return t.abrupt("return",a);case 5:return i=a.data.clientVars,c=null===(s=i.collab_client_vars)||void 0===s?void 0:s.initialAttributedText.text,u=Object(b.a)(a),null===(o=n.handleClientVars)||void 0===o||o.call(n,i,u),l=i.collab_client_vars,d=l.maxRow,h=l.padSubId,n._handleSliceRow(h,d,r),t.abrupt("return",{clientVars:i,spreadConfig:u,firstData:c,sheetId:h,isFinished:d<=n.firstDataRowCount+1,loader:n,isSuccess:!0});case 12:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()));case 2:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"loadSheetData",value:function(){var e=Object(a.a)(regeneratorRuntime.mark((function e(t){var r=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.work(),e.abrupt("return",new Promise(function(){var e=Object(a.a)(regeneratorRuntime.mark((function e(n,a){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.sheetId,t.onSuccess,r._handleSheetData(n,a,t);case 2:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()).then(function(){var e=Object(a.a)(regeneratorRuntime.mark((function e(n){var a,s,o,i,c,u,l;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r.isPause()){e.next=2;break}return e.abrupt("return");case 2:if(a=t.sheetId,s=t.onSuccess,o=t.onFail,i=n.isSuccess,n.isFinished,c=n.maxRow,i){e.next=6;break}return e.abrupt("return",n);case 6:if(t.ignoreChunk)r._loadChunkData({from:r.from+r.count+1,to:c-1||D.DEFAULT_ROW_COUNT,sheetId:a,callback:s}).catch((function(e){null===o||void 0===o||o(e)}));else for(u=Object(_.c)({from:r.from+r.count+1,to:c-1}),r._setSlicedRowCount(a,u.length),l=0;l<u.length;l+=1)r._loadChunkData({from:u[l].from,to:u[l].to,sheetId:a,callback:s}).catch((function(e){null===o||void 0===o||o(e)}));return null===s||void 0===s||s(n),e.abrupt("return",n);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_handleSliceRow",value:function(e,t,r){var n=this,a=Object(_.c)({from:this.firstDataRowCount+1,to:t||200});if(this._setSlicedRowCount(e,a.length),a.length){var s=0;!function t(){setTimeout((function(){if(s<a.length){var o=Math.min(a.length-1,s+2);o>a.length-1&&(o=a.length-1),function(t,s){for(var o=[],i=t;i<=s;i+=1)o.push(n._loadChunkData(E(E({},r),{},{from:a[i].from,to:a[i].to,sheetId:e,callback:r.onSuccess})));Promise.all(o).then((function(){o.length=0})).catch((function(e){var t;console.error(e),null===(t=r.onFail)||void 0===t||t.call(r,e),o.length=0}))}(s,o),s=o+1,t()}}),300)}()}else setTimeout((function(){r.onSuccess({startRow:-1,endRow:-1,sheetId:e,chunkData:[[[]]],isFinished:!0})}),0)}},{key:"_init",value:function(){this.slicedRowCount={},this.openDocRetryTimes=3}},{key:"_handleOpenDocResponse",value:function(){var e=Object(a.a)(regeneratorRuntime.mark((function e(t,r,n,a,s,o){var i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,i="string"===typeof r?JSON.parse(r):r,e.next=7;break;case 4:return e.prev=4,e.t0=e.catch(0),e.abrupt("return",n({isSuccess:!1,error:{type:m.b.OPEN_DOC_JSON_PARSE_ERROR,message:null===e.t0||void 0===e.t0?void 0:e.t0.stack},loader:this}));case 7:if("blankpage"!==i.padType){e.next=11;break}return e.next=10,this._handleBlankPage(t,i,n,a,s);case 10:return e.abrupt("return",e.sent);case 11:if("sheet"!==i.padType){e.next=14;break}return"fromRetry"===o&&g.b.run(O.CONFIG.SERVER_LOADER_HANDLE_OPEN_DOC_RESPONSE,"retryResolve",[this._containerID,i]),e.abrupt("return",n({isSuccess:!0,data:i,loader:this}));case 14:if("doc"!==i.padType){e.next=16;break}return e.abrupt("return",n({isSuccess:!0,error:{type:m.b.OPEN_DOC_PAD_TYPE_ERROR,message:"\u660e\u660e\u8bf7\u6c42\u7684\u662f sheet\uff0c\u5374\u8fd4\u56de\u4e86 doc\uff0c\u9700\u8981 url \u91cd\u65b0\u8df3\u8f6c"},loader:this}));case 16:return e.abrupt("return",a({isSuccess:!0,error:{type:m.b.OPEN_DOC_ERROR_UNKNOWN,message:"opendoc \u672a\u77e5\u9519\u8bef"},loader:this}));case 17:case"end":return e.stop()}}),e,this,[[0,4]])})));return function(t,r,n,a,s,o){return e.apply(this,arguments)}}()},{key:"handleOpenDocResponseJSONP",value:function(){var e=Object(a.a)(regeneratorRuntime.mark((function e(t,r,n,a,s){var o,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,o="string"===typeof t?JSON.parse(t):t,e.next=12;break;case 4:if(e.prev=4,e.t0=e.catch(0),"fromRetry"!==s){e.next=8;break}return e.abrupt("return",r({isSuccess:!1,error:{type:m.b.OPEN_DOC_JSON_PARSE_ERROR,message:null===e.t0||void 0===e.t0?void 0:e.t0.stack},loader:this}));case 8:return e.next=10,this._fetchOpenDoc(a);case 10:return i=e.sent,e.abrupt("return",this.handleOpenDocResponseJSONP(i.data,r,n,a,"fromRetry"));case 12:if("blankpage"!==o.padType){e.next=16;break}return e.next=15,this.handleBlankPageJSONP(o,r,n,a);case 15:return e.abrupt("return",e.sent);case 16:if("sheet"!==o.padType){e.next=18;break}return e.abrupt("return",r({isSuccess:!0,data:o,loader:this}));case 18:if("doc"!==o.padType){e.next=20;break}return e.abrupt("return",r({isSuccess:!0,error:{type:m.b.OPEN_DOC_PAD_TYPE_ERROR,message:"\u660e\u660e\u8bf7\u6c42\u7684\u662f sheet\uff0c\u5374\u8fd4\u56de\u4e86 doc\uff0c\u9700\u8981 url \u91cd\u65b0\u8df3\u8f6c"},loader:this}));case 20:return e.abrupt("return",n({isSuccess:!0,error:{type:m.b.OPEN_DOC_ERROR_UNKNOWN,message:"opendoc \u672a\u77e5\u9519\u8bef"},loader:this}));case 21:case"end":return e.stop()}}),e,this,[[0,4]])})));return function(t,r,n,a,s){return e.apply(this,arguments)}}()},{key:"_handleBlankPage",value:function(){var e=Object(a.a)(regeneratorRuntime.mark((function e(t,r,n,a,s){var o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(20!==r.clientVars.type){e.next=2;break}return e.abrupt("return",n({isSuccess:!1,error:{type:m.b.OPEN_DOC_PAD_NO_EXIST,message:"\u6587\u6863\u4e0d\u5b58\u5728"},loader:this}));case 2:if("true"===(t instanceof XMLHttpRequest?t.getResponseHeader("forbidden-retry"):t.headers["forbidden-retry"])){e.next=6;break}return g.b.run(O.CONFIG.SERVER_LOADER_HANDLE_OPEN_DOC_RESPONSE,O.CONFIG.SERVER_LOADER_HANDLE_OPEN_DOC_RESPONSE,[this._containerID,r]),e.abrupt("return",n({isSuccess:!0,error:{type:m.b.OPEN_DOC_BLANK_PAGE_FORBIDDEN_RETRY,message:"open\u540e\u53f0\u9519\u8bef\uff0c\u540e\u53f0\u4e0d\u5141\u8bb8\u91cd\u8bd5\uff0c\u5916\u5c42\u5e94\u8be5\u8df3\u8f6c\u5230\u7a7a\u767d\u9875\u9762\uff0c\u7ed9\u53c2\u65703\u548c data",data:r},loader:this}));case 6:if(!(this.openDocRetryTimes>0)){e.next=13;break}return this.openDocRetryTimes-=1,g.b.run(O.CONFIG.SERVER_LOADER_HANDLE_OPEN_DOC_RESPONSE,"retry",[this._containerID,r]),e.next=11,this._fetchOpenDoc(s);case 11:return o=e.sent,e.abrupt("return",this._handleOpenDocResponse(t,o.data,n,a,s,"fromRetry"));case 13:return e.abrupt("return",n({isSuccess:!0,error:{type:m.b.OPEN_DOC_BLANK_PAGE_ERROR_MAX_RETRY,message:"opendoc \u91cd\u8bd5\u4e86\u4e09\u6b21\uff0c\u4f9d\u7136\u8fd4\u56de\u7a7a\u767d\u9875\uff0c\u8981\u8df3\u8f6c\u5230\u7a7a\u9875\u9762\uff0c\u7ed9\u53c2\u65703\u548c data",data:r},loader:this}));case 14:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a,s){return e.apply(this,arguments)}}()},{key:"handleBlankPageJSONP",value:function(e,t,r,n){return 20===e.clientVars.type?t({isSuccess:!1,error:{type:m.b.OPEN_DOC_PAD_NO_EXIST,message:"\u6587\u6863\u4e0d\u5b58\u5728"},loader:this}):(g.b.run(O.CONFIG.SERVER_LOADER_HANDLE_OPEN_DOC_RESPONSE,O.CONFIG.SERVER_LOADER_HANDLE_OPEN_DOC_RESPONSE,[this._containerID,e]),t({isSuccess:!0,error:{type:m.b.OPEN_DOC_BLANK_PAGE_FORBIDDEN_RETRY,message:"opendoc \u76f4\u63a5\u5931\u8d25\uff0c\u4f9d\u7136\u8fd4\u56de\u7a7a\u767d\u9875\uff0c\u8981\u8df3\u8f6c\u5230\u7a7a\u9875\u9762\uff0c\u7ed9\u53c2\u65703\u548c data",data:e},loader:this}))}},{key:"_fetchOpenDoc",value:function(){var e=Object(a.a)(regeneratorRuntime.mark((function e(t){var r,n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._getOpenDocUrl(t.secretId,t.sheetId,this.from,this.from+this.count),g.b.run(O.CONFIG.SERVER_LOADER_FETCH_OPEN_DOC,[this._containerID,t.sheetId,this.from,this.count]),e.abrupt("return",d()({url:r,method:"GET",responseType:"json"}).then((function(e){return g.b.run(O.CONFIG.SERVER_LOADER_OPEN_DOC_RESPONSE,[n._containerID,t.sheetId,n.from,n.count]),e})));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_overWriteXhrReadyStateChange",value:function(e,t,r,n){var s=this;e.onreadystatechange=Object(a.a)(regeneratorRuntime.mark((function a(){var o;return regeneratorRuntime.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(e.readyState===XMLHttpRequest.DONE){a.next=2;break}return a.abrupt("return");case 2:if(200===e.status){a.next=10;break}if(!(s.openDocRetryTimes>0)){a.next=9;break}return s.openDocRetryTimes-=1,a.next=7,s._fetchOpenDoc(n);case 7:return o=a.sent,a.abrupt("return",s._handleOpenDocResponse(e,o.data,t,r,n,"fromRetry"));case 9:return a.abrupt("return",r({isSuccess:!1,error:{type:m.b.OPEN_DOC_NOT_200_ERROR_MAX_RETRY,message:"opendoc \u8fde\u7eed\u4e09\u6b21\u8bf7\u6c42\u975e 200"}}));case 10:s._handleOpenDocResponse(e,e.responseText,t,r,n);case 11:case"end":return a.stop()}}),a)})))}},{key:"_loadChunkData",value:function(){var e=Object(a.a)(regeneratorRuntime.mark((function e(t){var r=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=Object(a.a)(regeneratorRuntime.mark((function e(n,a){var s,o,i,c,u,l,h,p,f,_,b,k,D,R,E,I,y;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=v.a.getConfig("globalPadId"),c=t.sheetId,u=t.from,l=t.to,h=t.callback,p=r._getSheetCgi(i,c,u,l),g.b.run(O.CONFIG.LOADER,"loadChunkData",[r._containerID,r.name,u,l,c]),e.prev=4,e.next=7,d()({method:"get",url:p,responseType:"json"});case 7:f=e.sent,e.next=15;break;case 10:e.prev=10,e.t0=e.catch(4),console.error(e.t0),g.b.run(O.CONFIG.LOADER,"loadChunkDataError",[r._containerID,r.name,u,l,c,e.t0]),a({error:{message:e.t0},type:m.b.LOAD_ONLINE_SHEET_DATA_FAIL,code:m.a.FETCH_FAIL});case 15:if(null===(s=f)||void 0===s?void 0:s.data){e.next=18;break}return g.b.run(O.CONFIG.LOADER,"loadChunkDataNull",[r._containerID,r.name,u,l,c,f]),e.abrupt("return",a({error:{message:"chunk data is null"},type:m.b.LOAD_ONLINE_SHEET_DATA_FAIL,code:m.a.DATA_NULL}));case 18:if(g.b.run(O.CONFIG.LOADER,"loadChunkDataResponse",[r._containerID,r.name,u,l,c,f]),!r.isPause()){e.next=22;break}return g.b.run(O.CONFIG.LOADER,"loadChunkDataIsPause",[r._containerID,r.name,u,l,c]),e.abrupt("return");case 22:if(0!==(null===(o=f)||void 0===o?void 0:o.data.retcode)){e.next=33;break}return _=f.data.data,b=_.sheetId,k=_.startrow,D=_.endrow,R=f.data.data.initialAttributedText.text,r._decreaseSlicedRowCount(b),E={startRow:+k,endRow:+D,sheetId:b,chunkData:R,isFinished:0===r._getSlicedRowCount(b)},g.b.run(O.CONFIG.LOADER,"loadChunkDataCallback",[r._containerID,r.name,u,l,b,E]),e.next=30,null===h||void 0===h?void 0:h(E);case 30:n(E),e.next=35;break;case 33:g.b.run(O.CONFIG.LOADER,"loadChunkDataRetcode",[r._containerID,r.name,u,l,c,f]),a({error:{message:null===(I=f)||void 0===I?void 0:I.data.retcode},type:m.b.LOAD_ONLINE_SHEET_DATA_FAIL,code:"".concat(null===(y=f)||void 0===y?void 0:y.data.retcode)});case 35:case"end":return e.stop()}}),e,null,[[4,10]])})));return function(t,r){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getSheetCgi",value:function(e,t,r,n,a){var s=Object(f.b)(),o=location.search;(o=Object(k.removeURLParameters)(o,["uid","uid_key"]))&&o.indexOf("?")>-1?o+="&":o+="?";var i="preview_token",c=Object(p.getCookie)(i),u=v.a.getConfig("globalPadId"),l="/dop-api/get/sheet".concat(o,"padId=").concat(u,"&subId=").concat(t,"&startrow=").concat(r,"&endrow=").concat(n,"&xsrf=").concat(s,"&_r=").concat(Math.random(),"&outformat=1&normal=1&").concat(i,"=").concat(c,"&nowb=1");return a&&(l+="&rev=".concat(a)),l}},{key:"_getOpenDocUrl",value:function(e,t,r,n){var a=e||location.pathname.replace("/sheet/",""),s=location.search;(s=Object(k.removeURLParameters)(s,["uid","uid_key","tab"]))&&s.indexOf("?")>-1?s+="&":s+="?";var o="preview_token",i=Object(p.getCookie)(o),c=Object(f.b)();return t&&(s=Object(k.removeURLParameters)(s,"tab"),s+="tab=".concat(t)),"/dop-api/opendoc".concat(s,"&outformat=1&normal=1&id=").concat(a,"&").concat(o,"=").concat(i,"&startrow=").concat(r,"&endrow=").concat(n,"&t=").concat(Number(new Date),"&wb=1&nowb=0&xsrf=").concat(c)}},{key:"_handleSheetData",value:function(){var e=Object(a.a)(regeneratorRuntime.mark((function e(t,r,n){var a,s,o,i,c,u,l,d,h,p,f;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.sheetId,e.prev=1,e.next=4,this._fetchSheetChunk(n);case 4:s=e.sent,e.next=12;break;case 7:return e.prev=7,e.t0=e.catch(1),console.error(e.t0),g.b.run(O.CONFIG.LOADER,"handleSheetDataCatchError",[this._containerID,this.name,n,s]),e.abrupt("return",t({isSuccess:!1,error:{type:m.b.LOAD_ONLINE_SHEET_DATA_CATCH_ERROR,message:"\u5207\u8868 get/sheet \u62c9\u53d6\u6570\u636e catch \u5931\u8d25",code:-1,error:e.t0,sheetId:a},loader:this}));case 12:if(g.b.run(O.CONFIG.LOADER,"handleSheetData",[this._containerID,this.name,n,s]),!this.isPause()){e.next=16;break}return g.b.run(O.CONFIG.LOADER,"loaderIsPause",[this._containerID,this.name,n]),e.abrupt("return");case 16:if(s&&s.data&&0===s.data.retcode){e.next=19;break}return g.b.run(O.CONFIG.LOADER,"sheetDataError",[this._containerID,this.name,n,s]),e.abrupt("return",t({isSuccess:!1,error:{type:m.b.LOAD_ONLINE_SHEET_DATA_FAIL,message:"\u5207\u8868/\u9996\u5c4f\u6570\u636e\u62c9\u53d6\u5931\u8d25",code:(null===(o=s)||void 0===o||null===(i=o.data)||void 0===i?void 0:i.retcode)||-2,sheetId:a},loader:this}));case 19:return c=s.data.data,u=c.startrow,l=c.endrow,d=c.initialAttributedText,h=c.maxrow,p=d.text,f={isSuccess:!0,sheetId:a,chunkData:p,startRow:+u,endRow:+l,isFinished:"-1"===l||h<=+l+1,maxRow:h},g.b.run(O.CONFIG.LOADER,"handleSheetDataResolve",[this._containerID,this.name,n,f]),e.abrupt("return",t(f));case 25:case"end":return e.stop()}}),e,this,[[1,7]])})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_fetchSheetChunk",value:function(){var e=Object(a.a)(regeneratorRuntime.mark((function e(t){var r,n,a,s,o,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=v.a.getConfig("globalPadId"),n=t.sheetId,a=this.from,s=this.count,t.ignoreChunk&&(s=-1),o=this._getSheetCgi(r,n,a,s),g.b.run(O.CONFIG.LOADER,"fetchSheetChunk",[this._containerID,this.name,t,a,s]),e.prev=7,e.next=10,d()({method:"get",url:o,responseType:"json"});case 10:i=e.sent,e.next=23;break;case 13:if(e.prev=13,e.t0=e.catch(7),console.error(e.t0),this.retryFetchChunkTime+=1,!(this.retryFetchChunkTime<=2)){e.next=22;break}return e.next=20,this._fetchSheetChunk(t);case 20:e.next=23;break;case 22:throw"\u5207\u8868 get/sheet \u8bf7\u6c42\u6570\u636e catch \u5931\u8d25";case 23:return e.abrupt("return",i);case 24:case"end":return e.stop()}}),e,this,[[7,13]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_setSlicedRowCount",value:function(e,t){g.b.run(O.CONFIG.LOADER,"setSlicedRowCount",[this._containerID,this.name,e,t]),this.slicedRowCount[e]=t}},{key:"_getSlicedRowCount",value:function(e){return this.slicedRowCount[e]}},{key:"_decreaseSlicedRowCount",value:function(e){this.slicedRowCount[e]-=1,g.b.run(O.CONFIG.LOADER,"decreaseSlicedRowCount",[this._containerID,this.name,e,this.slicedRowCount])}}]),n}(h.a)}).call(this,r("../node_modules/webpack/buildin/global.js"))},"./src/core/network/datacenter/loader/automaticLogin.ts":function(e,t,r){"use strict";r.d(t,"a",(function(){return c}));r("../node_modules/core-js/modules/es.array.concat.js"),r("../node_modules/core-js/modules/es.regexp.exec.js"),r("../node_modules/core-js/modules/es.string.replace.js");var n=r("../node_modules/@tencent/docs-user-agent/dist/index.js"),a=r.n(n),s=r("./src/core/network/datacenter/loader/blankpageUtil.ts"),o=function(){if(a.a.isWeChat){var e="https://".concat(location.host,"/scenario/wx-login.html?target=").concat(encodeURIComponent(window.location.href));window.location.replace("https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx46dfe750eef96da7&redirect_uri=".concat(encodeURIComponent(e),"&response_type=code&scope=snsapi_userinfo&state=onweixinlogin"))}},i=function(){if(a.a.isWxWork){var e="https://".concat(location.host,"/scenario/ww-login.html?from=detail&url=").concat(encodeURIComponent(window.location.href));window.location.replace("https://open.weixin.qq.com/connect/oauth2/authorize?appid=ww20388f7040b655b7&redirect_uri=".concat(encodeURIComponent(e),"&response_type=code&scope=snsapi_userinfo&state=weworklogin#wechat_redirect"))}};function c(e,t){var r=e.error,n=(null===r||void 0===r?void 0:r.data).clientVars;(void 0===n?{}:n).isLogin||!a.a.isWeChat&&!a.a.isWxWork?Object(s.a)(3,t):(o(),i())}},"./src/core/network/datacenter/loader/blankpageUtil.ts":function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return o}));r("../node_modules/core-js/modules/es.regexp.exec.js"),r("../node_modules/core-js/modules/es.string.replace.js");var n=r("../node_modules/@tencent/tencent_doc_open_url/dist/index.js"),a=r("./src/external/view/mobile/header/native-header/api.ts"),s=r("./src/external/view/mobile/header/native-header/utils.ts");function o(t,r){var o=location.pathname.replace("/sheet/","");try{var i;Object(s.a)()&&a.a.hideButtonsBeforeJump();var c={};c[o]=3===t&&r?r:4===t?{padType:"blankpage",clientVars:{type:7}}:{padType:"blankpage",clientVars:{}},c[o].sourcePadType="sheet",c[o].sourceType=t,c[o]._openDocStartTime=window._openDocStartTime,c[o]._openDocEndTime=window._openDocEndTime;var u=JSON.stringify(c),l=location.href.replace("/sheet/","/blankpage/");null===(i=e.log)||void 0===i||i.warn("\u8df3\u8f6c\u5230\u7a7a\u767d\u9875 setBlankPageData",l,u),localStorage.setItem("blankPageData",u),setTimeout((function(){Object(n.tencentDocOpenUrlForAll)({url:l,replace:!0})}),300)}catch(d){throw d}}}).call(this,r("../node_modules/webpack/buildin/global.js"))},"./src/core/network/datacenter/loader/loaderErrorType.ts":function(e,t,r){"use strict";var n,a;r.d(t,"a",(function(){return a})),function(e){e.LOAD_OFFLINE_DOCUMENT_DATA_FAIL="LOAD_OFFLINE_DOCUMENT_DATA_FAIL",e.LOAD_OFFLINE_CHUNK_DATA_FAIL="LOAD_OFFLINE_CHUNK_DATA_FAIL",e.LOAD_OFFLINE_VERSION_DATA_NULL="LOAD_OFFLINE_VERSION_DATA_NULL",e.LOAD_OFFLINE_VERSION_DATA_INVALID="LOAD_OFFLINE_VERSION_DATA_INVALID",e.LOAD_OFFLINE_SHEET_DATA_FAIL="LOAD_OFFLINE_SHEET_DATA_FAIL",e.LOAD_ONLINE_DOCUMENT_DATA_FAIL="LOAD_ONLINE_DOCUMENT_DATA_FAIL",e.LOAD_ONLINE_SHEET_DATA_FAIL="LOAD_ONLINE_SHEET_DATA_FAIL",e.LOAD_ONLINE_SHEET_DATA_CATCH_ERROR="LOAD_ONLINE_SHEET_DATA_CATCH_ERROR",e.OPEN_DOC_JSON_PARSE_ERROR="OPEN_DOC_JSON_PARSE_ERROR",e.OPEN_DOC_BLANK_PAGE_FORBIDDEN_RETRY="OPEN_DOC_BLANK_PAGE_FORBIDDEN_RETRY",e.OPEN_DOC_BLANK_PAGE_ERROR_MAX_RETRY="OPEN_DOC_BLANK_PAGE_ERROR_MAX_RETRY",e.OPEN_DOC_NOT_200_ERROR_MAX_RETRY="OPEN_DOC_BLANK_PAGE_ERROR_MAX_RETRY",e.OPEN_DOC_PAD_TYPE_ERROR="OPEN_DOC_PAD_TYPE_ERROR",e.OPEN_DOC_ERROR_UNKNOWN="OPEN_DOC_ERROR_UNKNOWN",e.OPEN_DOC_PAD_NO_EXIST="OPEN_DOC_PAD_NO_EXIST",e.OPEN_DOC_AXIOS_ERROR="OPEN_DOC_AXIOS_ERROR"}(n||(n={})),function(e){e.DATA_NULL="DATA_NULL",e.RETCODE_ERROR="RETCODE_ERROR",e.FETCH_FAIL="FETCH_FAIL"}(a||(a={})),t.b=n},"./src/core/network/datacenter/loader/loaderUtil.ts":function(e,t,r){"use strict";(function(e){r.d(t,"c",(function(){return a})),r.d(t,"b",(function(){return s})),r.d(t,"a",(function(){return o}));r("../node_modules/core-js/modules/es.array.concat.js"),r("../node_modules/core-js/modules/es.regexp.exec.js"),r("../node_modules/core-js/modules/es.string.split.js");var n=r("../node_modules/@tencent/docs_offline/lib/index.js");function a(e){var t=e.from,r=e.to;if(t>r)return[];for(var n=[];t<=r;){if(!(t+3e3<r)){n.push({from:t,to:r});break}n.push({from:t,to:t+3e3}),t=t+3e3+1}return n}function s(t){var r=t.globalPadId,a=t.secretId,s=t.uid,o="string"===typeof r?r.split("$")[0]:"",i="string"===typeof r?r.split("$")[1]:"",c=t.title?1:0,u=t.title||"\u65e0\u6807\u9898\u8868\u683c",l="D0000000000000001"===a;return{appInfoConfig:null,padType:"sheet",isProPad:!0,shortLink:"https://".concat(location.host,"/sheet/").concat(a),docStatus:0,advPolicy:{view_forbid_copy_print:0,reader_can_comment:0,writer_can_comment:0},uin:"",isEmbed:!0,invitedGroupInfos:[],newOpenSvc:1,nameGuess:null,colorPalette:[],domainId:o,userId:s,useFbChat:!1,localPadId:i,userName:"",disableFB:!0,relativeUrl:null,collab_client_vars:{padType:"sheet",rev:0,client:{sid:"",upid:a,tid:0,sig:""},initialAttributedText:{text:[[[{t:14,v:5,c:["BB08J2",14,0,200]},{t:14,v:5,c:["BB08J2",2,0,26]}],[{t:3,v:5,c:[["BB08J2",0,60,0,25],{},{0:[],1:[],2:[]}]}]]],attribs:""},globalPadId:r,ver:6,bad:2,padSubId:"BB08J2",gray:0,apool:{},header:[{d:[{id:"BB08J2",name:"\u5de5\u4f5c\u88681"}],type:"ms"}],wmode:"wb",pos:1,websocket:!0,apid:{},pver:1,dirty:2,padId:i,websocketReopenCount:-1,dver:e.__globalCodeVersion,pollingAttemptNumber:0},padTitle:u,padStatus:t.isLocalNewFile||l?n.PadStatus.LOCAL:n.PadStatus.NORMAL,isUserChangeTitle:c,initialOptions:{guestPolicy:""},globalPadId:r,titleIsReadOnly:!0,relative:null,envi:{port:8084,type:1,ip:0},userColor:0,isOwner:!0,policy:0,friendUserIds:[],clientIp:"",userIsGuest:!1,proTitle:"",userDomain:"",ownerId:s,specialKey:null,isTimDomain:!0,isOverConNum:!1,shouldGetFbLoginStatus:!0,initialSpaces:null,ownerAppid:"",accountPrivs:{maxRevisions:1e8},isPublicPad:!1,userInfo:{uid:s,corp_id:"",uin:0,third_uid:"",domain:"",fullName:"",wx_openid:"oDzL40GSNzd1-VCksCAEF8hDYi7o"},padId:i,rightFlag:4294967295,isPadAdmin:!0,siteName:"",isLogin:!0,initialRevisionList:[],specialKeyTranslation:null,userPic:"",privilegeExpire:0,privilegeAttribute:{can_read:1,is_auth:1,can_edit:1,can_link_exp:1,can_watermark:1,can_history:1,can_copy_doc:1,can_translate:1,can_about:1,can_copy:1,can_comment:1,can_add_user:1,can_search:1,can_edit_title:1,can_share:1,can_spit_slot:1,can_view_image:1,can_print:1},creatorId:s,initialTitle:u,creatorDomain:o,isOpendocxfromTim:!1,isCreator:!1,encrypted:"",userLink:"",dropboxConnected:!1,invitedUserInfos:[],isTimOnline:!0,preview:"",lastModifyUser:"",createdDate:Date.now(),isSnapshot:!1,metaCreateTime:Date.now(),tinyid:"",lastModifyTime:Date.now(),oPadSubId:"BB08J2",userType:"",uidKey:"",vipInfo:"",enableToCVipFeature:!1,templateInfo:"",newPadType:""}}function o(e){return!(!e.data||!e.status||200!==e.status)}}).call(this,r("../node_modules/webpack/buildin/global.js"))},"./src/core/network/datacenter/serverDataManager.ts":function(e,t,r){"use strict";r.d(t,"c",(function(){return s})),r.d(t,"b",(function(){return o})),r.d(t,"a",(function(){return i}));var n=r("../packages/common-utils/src/url.ts"),a=r("./src/core/data/configService/spreadConfig.ts");function s(e){return e.isPreview=e.preview||Object(n.getQuery)("inToastPreview"),a.a.reloadConfig(e),a.a}function o(e){return s(e)}function i(e){return s(e.data.clientVars)}},"./src/core/network/message-center/base/BaseMessageCenter.ts":function(e,t,r){"use strict";r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.reflect.construct.js"),r("../node_modules/core-js/modules/es.regexp.to-string.js");var n=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),a=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),s=r("../node_modules/@babel/runtime/helpers/esm/inherits.js"),o=r("../node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn.js"),i=r("../node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js"),c=r("../node_modules/@babel/runtime/helpers/esm/get.js"),u=r("../packages/report/src/index.ts"),l=r("./src/base/config/report.ts"),d=r("../packages/lib/index.ts"),h=r("../packages/services/src/dispose.ts");function p(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=Object(i.a)(e);if(t){var a=Object(i.a)(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Object(o.a)(this,r)}}var f=function(e){Object(s.a)(r,e);var t=p(r);function r(e){var a;return Object(n.a)(this,r),(a=t.call(this))._currentVersion=0,a._onUpdate=new d.a,a.onUpdate=a._onUpdate.event,a._currentVersion=e.baseVersion,a}return Object(a.a)(r,[{key:"update",value:function(e){this._currentVersion>e?u.b.run(l.CONFIG.UPDATE_BASEVERSION_ERROR,[this._currentVersion,e]):(u.b.run(l.CONFIG.UPDATE_BASEVERSION,[this._currentVersion,e]),this._currentVersion=e,this._onUpdate.fire())}},{key:"dispose",value:function(){Object(c.a)(Object(i.a)(r.prototype),"dispose",this).call(this),this._currentVersion=-1}},{key:"version",get:function(){return this._currentVersion}}]),r}(h.a),_=r("./src/core/network/message-center/model/task/TaskQueue.ts"),m=r("./src/core/network/message-center/base/BaseSendMessageCenter.ts"),b=r("./src/core/network/message-center/base/BaseReceiveMessageCenter.ts");function v(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=Object(i.a)(e);if(t){var a=Object(i.a)(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Object(o.a)(this,r)}}var g=function(e){Object(s.a)(r,e);var t=v(r);function r(e){var a;return Object(n.a)(this,r),(a=t.call(this))._version=a._register(new f({baseVersion:e.baseVersion})),a._taskQueue=a._register(new _.a),a.initSendAndReceive(),a}return Object(a.a)(r,[{key:"initSendAndReceive",value:function(){this._sendMessageCenter=this._register(new m.a(this._app,{version:this._version,taskQueue:this._taskQueue})),this._receiveMessageCenter=new b.a(this._app,{version:this._version,taskQueue:this._taskQueue})}},{key:"taskQueue",get:function(){return this._taskQueue}},{key:"currentVersion",get:function(){return this._version.version}}]),r}(h.a);t.a=g},"./src/core/network/message-center/base/BaseReceiveMessageCenter.ts":function(e,t,r){"use strict";var n=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),a=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),s=function(){function e(t,r){Object(n.a)(this,e),this._app=t,this._version=r.version,this._taskQueue=r.taskQueue}return Object(a.a)(e,[{key:"currentVersion",get:function(){return this._version.version}}]),e}();t.a=s},"./src/core/network/message-center/base/BaseSendMessageCenter.ts":function(e,t,r){"use strict";r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.reflect.construct.js"),r("../node_modules/core-js/modules/es.regexp.to-string.js");var n=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),a=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),s=r("../node_modules/@babel/runtime/helpers/esm/inherits.js"),o=r("../node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn.js"),i=r("../node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js"),c=r("../packages/services/src/dispose.ts"),u=r("../packages/lib/index.ts");function l(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=Object(i.a)(e);if(t){var a=Object(i.a)(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Object(o.a)(this,r)}}var d=function(e){Object(s.a)(r,e);var t=l(r);function r(e,a){var s;return Object(n.a)(this,r),(s=t.call(this))._commitingQueue=null,s._waitingQueue=[],s._onUpdateBaseVersion=new u.a,s.onUpdateBaseVersion=s._onUpdateBaseVersion.event,s._updateBaseVersion=function(){var e=s._version.version;s._commitingQueue&&(s._commitingQueue.baseVersion=e);for(var t=0;t<s._waitingQueue.length;t++)s._waitingQueue[t]&&(s._waitingQueue[t].baseVersion=e);s._onUpdateBaseVersion.fire({waitingQueue:s._waitingQueue})},s._app=e,s._version=a.version,s._register(s._version.onUpdate((function(e){return s._updateBaseVersion()}))),s._taskQueue=a.taskQueue,s}return Object(a.a)(r,[{key:"commitingQueue",get:function(){return this._commitingQueue}},{key:"waitingQueue",get:function(){return this._waitingQueue}},{key:"currentVersion",get:function(){return this._version.version}}]),r}(c.a);t.a=d},"./src/core/network/message-center/model/MissChange.ts":function(e,t,r){"use strict";var n=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js");t.a=function e(t){Object(n.a)(this,e),this.isValid=!0,this.commitId=t.commitId,this.sheetId=t.subId,this.newVersion=t.newRev,this.changeset=t.changeset,this.isNeedKeyframe=t.need,this.head=t.head,this.isWorkbook=t.isWorkbook||!1,this.revert=t.revert,this.collabUserId=t.author}},"./src/core/network/message-center/model/PendingControl.ts":function(e,t,r){"use strict";r("../node_modules/core-js/modules/es.object.keys.js");var n=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),a=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),s=function(){function e(){Object(n.a)(this,e),this._sheet={},this._loadingCount=0}return Object(a.a)(e,[{key:"startLoadSheet",value:function(e){return this._sheet[e]?(console.error("sheet has loading"),!1):(this._loadingCount=this._loadingCount+1,this._sheet[e]=1,!0)}},{key:"finishLoadSheet",value:function(e){return this._sheet[e]?(this._loadingCount=this._loadingCount-1,delete this._sheet[e],!0):(console.error("sheet has't loading"),!1)}},{key:"loadingCount",get:function(){return this._loadingCount}},{key:"sheet",get:function(){return Object.keys(this._sheet)}}]),e}();t.a=s},"./src/core/network/message-center/model/UserChange.ts":function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return n}));r("../node_modules/core-js/modules/es.array.concat.js"),r("../node_modules/core-js/modules/es.array.for-each.js"),r("../node_modules/core-js/modules/web.dom-collections.for-each.js");var n,a=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),s=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),o=r("../packages/report/src/index.ts"),i=r("./src/base/config/report.ts");!function(e){e[e.WATING=0]="WATING",e[e.COMMITING=1]="COMMITING",e[e.ACCEPT=2]="ACCEPT"}(n||(n={}));var c=function(){function t(r){var s,c,u=this;(Object(a.a)(this,t),this.head=!1,this.isWorkbook=!1,this.status=n.WATING,this.taskId=0,this.isOfflineMessage=!1,this.allowAutoMerge=!1,this.commitTimes=0,this.createMessageSeq=function(){return Math.ceil(2147483648*Math.random())},this.globalPadId=r.globalPadId,this.baseVersion=r.baseVersion,this.sheetId=r.sheetId,this.mutations=[],r.data)&&(null===r||void 0===r||null===(s=r.data)||void 0===s||null===(c=s.mutations)||void 0===c||c.forEach((function(e){if(e&&Array.isArray(e)){var t=[];e.forEach((function(e){var r=window.SpreadsheetApp.mutationBehavior.deserializeMutation(e);r&&t.push(r)})),u.mutations.push(t)}else o.b.run(i.CONFIG.INIT_DATA_ERROR,[r.data.mutations])})),this.changeData=r.data.changedata||r.data.changeData||null,this.keyData=r.data.keyData||null,this.head=r.data.head||!1,this.isWorkbook=r.data.isWorkbook||!1,this.originSheetId=r.data.oSubId||null,this.taskId=r.data.taskId||this.createMessageSeq());this.isOfflineMessage=r.isOfflineMessage||!1,this.allowAutoMerge=r.allowAutoMerge||!1,this.time=r.time||(new Date).getTime(),this.status=r.status||n.WATING,this.dver=r.dver||e.__globalCodeVersion}return Object(s.a)(t,[{key:"isMutationChange",value:function(){return!this.changeData}},{key:"setChangeData",value:function(e){this.changeData=e}},{key:"setOrAppendMutations",value:function(e){this.mutations.push(e)}},{key:"setKeyData",value:function(e){this.keyData=e}},{key:"isWithKeyData",value:function(){return!!this.keyData}},{key:"requestCount",get:function(){return this.isMutationChange()?(null===this||void 0===this?void 0:this.mutations.length)||0:1}},{key:"isEmpty",get:function(){return(!this.mutations||0===this.mutations.length)&&!this.changeData||0===this.taskId}},{key:"key",get:function(){return"".concat(this.globalPadId,"_").concat(this.sheetId,"_").concat(this.time)}}]),t}();t.b=c}).call(this,r("../node_modules/webpack/buildin/global.js"))},"./src/core/network/message-center/model/missChange-helper.ts":function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return E})),r.d(t,"b",(function(){return y})),r.d(t,"c",(function(){return C}));r("../node_modules/core-js/modules/es.array.concat.js"),r("../node_modules/core-js/modules/es.array.map.js"),r("../node_modules/core-js/modules/es.object.assign.js"),r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.promise.js");var n=r("../node_modules/@babel/runtime/helpers/esm/toConsumableArray.js"),a=(r("../node_modules/regenerator-runtime/runtime.js"),r("../node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js")),s=r("../node_modules/axios/index.js"),o=r.n(s),i=r("../packages/common-utils/src/url.ts"),c=r("./src/core/network/message-center/model/MissChange.ts"),u=r("../packages/report/src/index.ts"),l=r("./src/base/config/report.ts"),d=r("./src/base/error/errCodeType.ts"),h=r("../packages/utils/src/safe.ts");r("./src/core/worker/worker-thread/index.ts");function p(e){return!(void 0!=e.revUpper&&e.revUpper<e.revLower)}function f(e){return _.apply(this,arguments)}function _(){return(_=Object(a.a)(regeneratorRuntime.mark((function e(t){var r,n,a,s,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.next=6;break;case 3:e.t0=e.sent,e.next=7;break;case 6:e.t0=Object(h.b)();case 7:return r=e.t0,n=Object(i.getQuery)("snaptk"),a=Object(i.getQuery)("snapts"),s=void 0===t.revUpper?"":"&to=".concat(t.revUpper),o="/dop-api/get/changes?padId=".concat(t.padId,"&from=").concat(t.revLower).concat(s,"&xsrf=").concat(r,"&snpatk=").concat(n,"&snapts=").concat(a),e.abrupt("return",o);case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function m(e){return b.apply(this,arguments)}function b(){return(b=Object(a.a)(regeneratorRuntime.mark((function t(r){var n,a;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,o()({method:"get",url:r,responseType:"json"});case 3:return n=t.sent,t.abrupt("return",{isSuccess:!0,data:n});case 7:return t.prev=7,t.t0=t.catch(0),null===(a=e.log)||void 0===a||a.error("sendMissChangesRequest catch error.",null===t.t0||void 0===t.t0?void 0:t.t0.stack),t.abrupt("return",{isSuccess:!1,data:void 0});case 11:case"end":return t.stop()}}),t,null,[[0,7]])})))).apply(this,arguments)}function v(e){return g.apply(this,arguments)}function g(){return(g=Object(a.a)(regeneratorRuntime.mark((function e(t){var r,n,a,s=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=s.length>1&&void 0!==s[1]?s[1]:2,n={isSuccess:!1,data:void 0},a=0;case 3:if(!(a<r)){e.next=15;break}return e.next=6,m(t);case 6:if(!(n=e.sent).isSuccess){e.next=10;break}return 1===a&&u.b.monitor(34276670),e.abrupt("break",15);case 10:return e.next=12,new Promise((function(e,t){setTimeout((function(){e()}),1e3)}));case 12:a+=1,e.next=3;break;case 15:return e.abrupt("return",n);case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function O(e){var t=e||{},r=t.status,n=t.data,a=t.statusText,s=void 0===a?"response is void":a;if(void 0===n)return{isSuccess:!1,data:void 0,errorCode:d.a.FETCH_USER_CHANGE_RESPONSE_DATA_EMPTY,errorMessage:s,reportCode:l.CONFIG.FETCH_USERCHANGES_3,reportOptions:[r,n]};var o,i=n.retcode,h=n.result;if(0!==i)return(o=n.retcode)&&u.b.monitor({1e5:33612375,100002:33612376,100003:33612377,200105:33612378,200200:33612379}[o]),{isSuccess:!1,data:void 0,errorCode:d.a.FETCH_USER_CHANGE_RESPONSE_ERROR_CODE,errorMessage:"retcode=".concat(n.retcode)};var p=h.to,f=h.rev,_=h.changes;return 0===_.length?(u.b.monitor(33633645),{isSuccess:!1,data:void 0,errorCode:d.a.FETCH_USER_CHANGE_RESPONSE_ARRAY_EMPTY,errorMessage:"userchanges\u957f\u5ea6\u4e3a0"}):{isSuccess:!0,data:{maxRev:p,endRev:f,misschanges:_.map((function(e){var t=e.data;return new c.a(t)}))}}}function k(e){return D.apply(this,arguments)}function D(){return(D=Object(a.a)(regeneratorRuntime.mark((function e(t){var r,n,a,s,o,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=0,p(t)){e.next=3;break}return e.abrupt("return",{isSuccess:!1,data:void 0,errorCode:d.a.FETCH_USER_CHANGE_RESPONSE_DATA_EMPTY,errorMessage:"\u53c2\u6570to\u5c0f\u4e8efrom",reportCode:l.CONFIG.FETCH_USERCHANGE_ARGUMENT,reportOptions:[t.revLower,t.revUpper]});case 3:return u.b.run(l.CONFIG.FETCH_USERCHANGES,[t.revLower,t.revUpper,r]),e.next=6,f(t);case 6:return n=e.sent,e.next=9,v(n);case 9:if(a=e.sent,s=a.isSuccess,o=a.data,s){e.next=13;break}return e.abrupt("return",{isSuccess:!1,data:void 0,errorCode:d.a.FETCH_USER_CHANGE_CGI_HTTP_ERROR,errorMessage:"fetch cgi error."});case 13:return i=O(o),e.abrupt("return",i);case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function R(e,t,r){return void 0===e&&r>t?{isFinish:!1,revLower:t+1,revUpper:r}:void 0!==e&&e>t?{isFinish:!1,revLower:t+1,revUpper:e}:{isFinish:!0}}function E(e){return I.apply(this,arguments)}function I(){return(I=Object(a.a)(regeneratorRuntime.mark((function e(t){var r,a,s,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],a=Object.assign({},t);case 2:return e.next=5,k(a);case 5:if((s=e.sent).isSuccess){e.next=10;break}return t.callback(!1,s.data,s.errorCode,s.errorMessage),void 0!==s.reportCode&&u.b.run(s.reportCode,s.reportOptions),e.abrupt("return");case 10:if(r.push.apply(r,Object(n.a)(s.data.misschanges)),!(o=R(t.revUpper,s.data.maxRev,s.data.endRev)).isFinish){e.next=15;break}return t.callback(!0,r),e.abrupt("return");case 15:a=Object.assign(t,{revLower:o.revLower,revUpper:o.revUpper}),e.next=2;break;case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function y(e){return{commitId:e.commitId,subId:e.sheetId,newRev:e.newVersion,changeset:e.changeset,need:e.isNeedKeyframe,head:e.head,revert:e.revert,author:e.collabUserId}}function C(e){return new c.a(e)}}).call(this,r("../node_modules/webpack/buildin/global.js"))},"./src/core/network/message-center/model/task/AcceptTask.ts":function(e,t,r){"use strict";r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.reflect.construct.js"),r("../node_modules/core-js/modules/es.regexp.to-string.js"),r("../node_modules/regenerator-runtime/runtime.js");var n=r("../node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js"),a=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),s=r("../node_modules/@babel/runtime/helpers/esm/inherits.js"),o=r("../node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn.js"),i=r("../node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js"),c=r("./src/core/network/message-center/model/task/MissChangeTask.ts"),u=r("./src/core/network/message-center/model/task/TaskType.ts");function l(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=Object(i.a)(e);if(t){var a=Object(i.a)(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Object(o.a)(this,r)}}var d=function(e){Object(s.a)(r,e);var t=l(r);function r(e,s){var o;return Object(a.a)(this,r),(o=t.call(this,e,s)).type=u.a.ACCEPT,o.isNeedKeyframe=!1,o.onInit=function(){return!(o.to<=o.parent.currentVersion)},o.onPrepare=Object(n.a)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!0);case 1:case"end":return e.stop()}}),e)}))),o.onStart=function(){if(o.to>o.parent.currentVersion+1){var e=new r(o.queue,{sheetId:o.sheetId,to:o.to,taskId:o.taskId,parent:o.parent}),t=new c.a(o.queue,{from:o.parent.currentVersion+1,to:o.to-1,parent:o.parent.receiveMessageCenter});o.queue.pushTask([t,e],0)}else o.to===o.parent.currentVersion+1&&o.parent.sendMessageCenter.acceptCommit(o.sheetId,o.to,o.isNeedKeyframe,o.taskId)},o.onFinish=function(){},o.sheetId=s.sheetId,o.to=s.to,o.taskId=s.taskId,o.isNeedKeyframe=s.isNeedKeyframe||!1,o.parent=s.parent,o}return r}(r("./src/core/network/message-center/model/task/BaseTask.ts").a);t.a=d},"./src/core/network/message-center/model/task/BaseTask.ts":function(e,t,r){"use strict";(function(e){r("../node_modules/core-js/modules/es.array.concat.js"),r("../node_modules/regenerator-runtime/runtime.js");var n,a=r("../node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js"),s=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),o=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),i=r("./src/core/network/message-center/model/task/TaskRunResult.ts");!function(e){e[e.INIT=0]="INIT",e[e.PREPARE=1]="PREPARE",e[e.START=2]="START",e[e.FINISH=3]="FINISH",e[e.DESTORY=4]="DESTORY"}(n||(n={}));var c=function(){function t(r,a){Object(s.a)(this,t),this._isPaused=!1,this._currentStatus=n.INIT,this.isValidTask=!0,this.queue=r,this._containerID=e.containerID}return Object(o.a)(t,[{key:"pause",value:function(){this._isPaused=!0}},{key:"continue",value:function(){var e=Object(a.a)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._isPaused=!1,e.next=3,this.run();case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"isPaused",value:function(){return this._isPaused}},{key:"run",value:function(){var t=Object(a.a)(regeneratorRuntime.mark((function t(){var r,n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null===(r=e.log)||void 0===r||r.info("task ".concat(this.containerID," run  taskType: ").concat(this.type)),t.prev=1,this.init(),this.isValidTask=this.onInit(),this.isValidTask){t.next=7;break}return this.destroy(),t.abrupt("return",i.a.ERROR_INVALID);case 7:return this.prepare(),t.next=10,this.onPrepare();case 10:if(!this.isPaused()){t.next=12;break}return t.abrupt("return",i.a.ERROR_PAUSED);case 12:return this.start(),this.onStart(),this.finish(),this.onFinish(),this.destroy(),t.abrupt("return",i.a.SUCCESS);case 20:return t.prev=20,t.t0=t.catch(1),null===(n=e.log)||void 0===n||n.error("error occur while run task!",null===t.t0||void 0===t.t0?void 0:t.t0.stack),this.queue.handleTaskError(t.t0,this),t.abrupt("return",i.a.ERROR_RUN_ERROR);case 25:case"end":return t.stop()}}),t,this,[[1,20]])})));return function(){return t.apply(this,arguments)}}()},{key:"init",value:function(){this._currentStatus=n.INIT}},{key:"prepare",value:function(){this._currentStatus=n.PREPARE}},{key:"start",value:function(){this._currentStatus=n.START}},{key:"finish",value:function(){this._currentStatus=n.FINISH}},{key:"destroy",value:function(){this._currentStatus=n.DESTORY,this.queue.onTaskDestroy(this)}},{key:"containerID",get:function(){return this._containerID}}]),t}();t.a=c}).call(this,r("../node_modules/webpack/buildin/global.js"))},"./src/core/network/message-center/model/task/MissChangeTask.ts":function(e,t,r){"use strict";(function(e){r("../node_modules/core-js/modules/es.array.filter.js"),r("../node_modules/core-js/modules/es.array.for-each.js"),r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.promise.js"),r("../node_modules/core-js/modules/es.reflect.construct.js"),r("../node_modules/core-js/modules/es.regexp.to-string.js"),r("../node_modules/core-js/modules/web.dom-collections.for-each.js"),r("../node_modules/regenerator-runtime/runtime.js");var n=r("../node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js"),a=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),s=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),o=r("../node_modules/@babel/runtime/helpers/esm/inherits.js"),i=r("../node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn.js"),c=r("../node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js"),u=r("./src/core/network/message-center/model/missChange-helper.ts"),l=r("./src/core/network/message-center/model/task/BaseTask.ts"),d=r("./src/core/network/message-center/model/task/TaskType.ts"),h=r("../packages/report/src/index.ts"),p=r("./src/base/config/report.ts"),f=r("./src/base/error/errCodeType.ts");function _(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=Object(c.a)(e);if(t){var a=Object(c.a)(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Object(i.a)(this,r)}}window;var m=function(t){Object(o.a)(i,t);var r=_(i);function i(t,s){var o;return Object(a.a)(this,i),(o=r.call(this,t,s)).type=d.a.MISS_CHANGE,o.onInit=function(){return!(void 0!==o.to&&o.to<=o.parent.currentVersion)&&(o.from<=o.parent.currentVersion&&(o.from=o.parent.currentVersion+1),!0)},o.onPrepare=Object(n.a)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(void 0!==o.to&&o.from>o.to||void 0!==o.to&&o.to===o.parent.currentVersion)){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,o.fetchMissChangeFromServer(o.from,o.to);case 4:o.missChangeList=e.sent;case 5:case"end":return e.stop()}}),e)}))),o.onStart=function(){var t,r;null===(t=e.log)||void 0===t||t.info("MisschangeTask onStart. ".concat(null===(r=o.missChangeList)||void 0===r?void 0:r.length)),o.missChangeList&&o.missChangeList.forEach((function(e,t,r){o.parent.applyNewChanges(e,t,r.length,"missing",o.extra)}))},o.onFinish=function(){},o.from=s.from,o.to=s.to,o.parent=s.parent,o.extra=s.extra,o}return Object(s.a)(i,[{key:"fetchMissChangeFromServer",value:function(t,r){var n=this;return new Promise((function(a,s){var o={padId:n.parent.app.spreadsheet.getSpreadsheetId(),revLower:t,revUpper:r,callback:function(r,n,o,i){if(r&&n){for(var c,u=0;u<n.length;u++){var l=n[u];if(0===u)c=l.newVersion;else{if(l.newVersion!==c+1)return h.b.run(p.CONFIG.FETCH_USERCHANGES_ERROR,[l.newVersion,c]),void s(f.a.FETCH_USER_CHANGE_RESPONSE_NOT_CONTINUE);c=l.newVersion}}h.b.jank.log({moduleValue:"messageCenter",actionValue:"fetchAndApplyCollabNewChanges",lockJankKey:!0});var d=n.filter((function(e){return e.newVersion>=t}));a(d)}else{var _;null===(_=e.log)||void 0===_||_.error("fetchAndApplyMisschangesError",o,i),s(f.a.PERMISSION_CHANGE)}}};Object(u.a)(o)}))}}]),i}(l.a);t.a=m}).call(this,r("../node_modules/webpack/buildin/global.js"))},"./src/core/network/message-center/model/task/TaskQueue.ts":function(e,t,r){"use strict";(function(e){r("../node_modules/core-js/modules/es.array.concat.js"),r("../node_modules/core-js/modules/es.array.map.js"),r("../node_modules/core-js/modules/es.array.splice.js"),r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.reflect.construct.js"),r("../node_modules/core-js/modules/es.regexp.to-string.js");var n,a=r("../node_modules/@babel/runtime/helpers/esm/toConsumableArray.js"),s=(r("../node_modules/regenerator-runtime/runtime.js"),r("../node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js")),o=r("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),i=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),c=r("../node_modules/@babel/runtime/helpers/esm/get.js"),u=r("../node_modules/@babel/runtime/helpers/esm/inherits.js"),l=r("../node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn.js"),d=r("../node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js"),h=r("./src/core/network/message-center/model/task/TaskRunResult.ts"),p=r("../packages/services/src/dispose.ts"),f=r("../packages/lib/index.ts");function _(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=Object(d.a)(e);if(t){var a=Object(d.a)(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Object(l.a)(this,r)}}!function(e){e[e.WORKING=0]="WORKING",e[e.PAUSE=1]="PAUSE",e[e.IDLE=2]="IDLE",e[e.SHUTDOWN=3]="SHUTDOWN"}(n||(n={}));var m=function(t){Object(u.a)(l,t);var r=_(l);function l(){var t;return Object(o.a)(this,l),(t=r.call(this))._taskList=[],t._status=n.IDLE,t._onTaskError=new f.a,t.onTaskError=t._onTaskError.event,t.callPauseCount=0,t._containerID=e.containerID,t}return Object(i.a)(l,[{key:"handleTaskError",value:function(t,r){var n;null===(n=e.log)||void 0===n||n.error("OnTaskError",null===t||void 0===t?void 0:t.stack,r.containerID,this.containerID),this.shutdown(),this._onTaskError.fire(t)}},{key:"isEmpty",value:function(){return 0===this._taskList.length}},{key:"isQueueWorking",value:function(){return this._status===n.WORKING}},{key:"shutdown",value:function(){this.switchStatus(n.SHUTDOWN)}},{key:"onTaskDestroy",value:function(){var e=Object(s.a)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._currentTask=void 0,this.isQueueWorking()&&this.work();case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"pause",value:function(){var t;null===(t=e.log)||void 0===t||t.info("TaskQueue call pause(). count=".concat(this.callPauseCount),this.containerID),this.callPauseCount+=1,this.switchStatus(n.PAUSE),this._currentTask&&(this._currentTask.pause(),this.pushTask(this._currentTask,0))}},{key:"resume",value:function(){var t,r;(null===(t=e.log)||void 0===t||t.info("TaskQueue call resume(). count=".concat(this.callPauseCount),this.containerID),this.callPauseCount=this.callPauseCount>1?this.callPauseCount-1:0,this.callPauseCount>0)||(this._status!==n.SHUTDOWN?this.switchStatus(n.WORKING):null===(r=e.log)||void 0===r||r.error("TaskQueue has been ShutDown. resume failed.",this.containerID))}},{key:"pushTask",value:function(t,r){var s,o,i=Array.isArray(t)?t.map((function(e){return{taskId:e.containerID,taskType:e.type}})):{taskId:t.containerID,taskType:t.type};(null===(s=e.log)||void 0===s||s.info("".concat(this.containerID," pushTask ").concat(r," ").concat(this._taskList.length," ").concat(this._status," taskInfos:"),i),void 0===r&&(r=this.length),Array.isArray(t))?(o=this._taskList).splice.apply(o,[r,0].concat(Object(a.a)(t))):this._taskList.splice(r,0,t);this._status===n.IDLE&&this.switchStatus(n.WORKING)}},{key:"work",value:function(){this.hasNext()?this.runNext():this.switchStatus(n.IDLE)}},{key:"runNext",value:function(){var t=Object(s.a)(regeneratorRuntime.mark((function t(){var r,n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this._currentTask=this.popTask(),!this._currentTask){t.next=13;break}if(!this._currentTask.isPaused()){t.next=8;break}return t.next=5,this._currentTask.continue();case 5:t.t0=t.sent,t.next=11;break;case 8:return t.next=10,this._currentTask.run();case 10:t.t0=t.sent;case 11:(r=t.t0)!==h.a.SUCCESS&&(null===(n=e.log)||void 0===n||n.info("TaskQueue. task run finish with exception. result= ".concat(r,"  task=").concat(this._currentTask),this.containerID));case 13:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"hasNext",value:function(){return!this.isEmpty()}},{key:"popTask",value:function(){if(0!==this.length)return this._taskList.shift()}},{key:"switchStatus",value:function(t){if(this._status!==n.SHUTDOWN){var r=!1;this._status!==n.WORKING&&t===n.WORKING&&(r=!0),this._status=t,r&&this.work()}else{var a;null===(a=e.log)||void 0===a||a.error("TaskQueue has been ShutDown. switchStatus failed.",this.containerID)}}},{key:"dispose",value:function(){Object(c.a)(Object(d.a)(l.prototype),"dispose",this).call(this),this.pause(),this.shutdown()}},{key:"containerID",get:function(){return this._containerID}},{key:"status",get:function(){return this._status}},{key:"length",get:function(){return this._taskList.length}}]),l}(p.a);t.a=m}).call(this,r("../node_modules/webpack/buildin/global.js"))},"./src/core/network/message-center/model/task/TaskRunResult.ts":function(e,t,r){"use strict";var n;r.d(t,"a",(function(){return n})),function(e){e[e.SUCCESS=0]="SUCCESS",e[e.ERROR_INVALID=1]="ERROR_INVALID",e[e.ERROR_RUN_ERROR=2]="ERROR_RUN_ERROR",e[e.ERROR_PAUSED=3]="ERROR_PAUSED"}(n||(n={}))},"./src/core/network/message-center/model/task/TaskType.ts":function(e,t,r){"use strict";var n;r.d(t,"a",(function(){return n})),function(e){e[e.UNKNOWN=-1]="UNKNOWN",e[e.ACCEPT=0]="ACCEPT",e[e.PUSH=1]="PUSH",e[e.COMMIT_ERROR=2]="COMMIT_ERROR",e[e.MISS_CHANGE=3]="MISS_CHANGE"}(n||(n={}))},"./src/core/network/message-center/model/userChange-helper.ts":function(e,t,r){"use strict";(function(e){r.d(t,"f",(function(){return i})),r.d(t,"d",(function(){return c})),r.d(t,"e",(function(){return u})),r.d(t,"b",(function(){return l})),r.d(t,"a",(function(){return d})),r.d(t,"c",(function(){return h}));r("../node_modules/core-js/modules/es.array.for-each.js"),r("../node_modules/core-js/modules/web.dom-collections.for-each.js");var n=r("./src/core/network/message-center/model/UserChange.ts"),a=r("../packages/report/src/index.ts"),s=r("./src/base/config/report.ts");function o(e){if(e.changeData)return JSON.stringify(e.changeData);if(e.mutations){var t=[];return e.mutations.forEach((function(e){var r=[];e.forEach((function(e){var t=window.SpreadsheetApp.mutationBehavior.serializeMutation(e);r.push(t)})),t.push(r)})),JSON.stringify(t)}return JSON.stringify([])}function i(e){var t,r={};r.baseVersion=e.baseVersion,r.sheetId=e.sheetId;var n=[];e.mutations&&e.mutations.forEach((function(t){var r=[];t.forEach((function(t){var n=window.SpreadsheetApp.mutationBehavior.serializeMutation(t);n?r.push(n):a.b.run(s.CONFIG.STORE_DATA_ERROR,[e.mutations])})),n.push(r)}));var o=e.changeData||null;return t={type:"USER_CHANGES",taskId:e.taskId,baseRev:e.baseVersion,mutations:n,changeData:o,keyData:e.keyData,head:e.head,subId:e.sheetId,oSubId:e.originSheetId||!1,pver:1},r.isOfflineMessage=!0,r.data=t,r.time=e.time,r.status=e.status,r.dver=e.dver,r}function c(e){var t={type:"USER_CHANGES",baseRev:e.baseVersion,changeset:o(e),keydata:e.keyData||!1,head:e.head,isWorkbook:e.isWorkbook,subId:e.sheetId,oSubId:e.originSheetId||!1,changeSetCount:e.requestCount,offlineMsg:e.isOfflineMessage,pver:1};return t.changeset="".concat(t.changeset,"\n"),t.keydata&&(t.keydata="".concat(t.keydata,"\n")),JSON.stringify(t)}function u(t){var r={type:"USER_CHANGES",baseRev:t.baseVersion,changeset:o(t),keydata:t.keyData||!1,head:t.head,subId:t.sheetId,oSubId:t.originSheetId||!1,changeSetCount:t.requestCount,offlineMsg:t.isOfflineMessage,pver:1};return r.dver=e.__globalCodeVersion,r.changesetLength=r.changeset.length,r.keydataLength=r.keydata?r.keydata.length:0,r.changeset=r.changeset.substr(0,100),r.keydata=!!r.keydata,r}function l(e){var t={globalPadId:e.globalPadId,baseVersion:e.baseVersion,sheetId:e.sheetId,status:e.status,data:{}};if(e.mutations){var r=[];e.mutations.forEach((function(e){var t=[];e.forEach((function(e){var r=window.SpreadsheetApp.mutationBehavior.serializeMutation(e);t.push(r)})),r.push(t)})),t.data.mutations=JSON.stringify(r)}return e.changeData&&(t.data.changeData=JSON.stringify(e.changeData)),void 0!==e.head&&(t.data.head=e.head),void 0!==e.originSheetId&&(t.data.oSubId=e.originSheetId),void 0!==e.taskId&&(t.data.taskId=e.taskId),t}function d(e){var t=e;if(t.data.mutations)try{t.data.mutations=JSON.parse(t.data.mutations)}catch(r){}return t.data.changeData&&(t.data.changeData=JSON.parse(t.data.changeData)),new n.b(t)}function h(e,t){var r=this;t.mutations&&t.mutations.length>0&&t.mutations.forEach((function(t){t.forEach((function(t){e.mutationBehavior.applyMutation(t,{isLocal:!1,isOffline:!0})}))})),t.changeData&&t.changeData.forEach((function(e){if("revert"===e.type)r.app.socket&&r.app.socket.handleRevert();else if("ms"===e.type){e.d;t.keyData}}))}}).call(this,r("../node_modules/webpack/buildin/global.js"))}}]);
//# sourceMappingURL=pc-chunk_part4-116ac07f02.js.map