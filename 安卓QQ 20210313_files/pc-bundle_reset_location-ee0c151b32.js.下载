(window.webpackJsonp=window.webpackJsonp||[]).push([["bundle_reset_location"],{"./src/external/resetLocation/index.ts":function(e,t,o){"use strict";o.r(t),function(e){o("../node_modules/core-js/modules/es.array.concat.js"),o("../node_modules/core-js/modules/es.array.for-each.js"),o("../node_modules/core-js/modules/es.array.iterator.js"),o("../node_modules/core-js/modules/es.map.js"),o("../node_modules/core-js/modules/es.object.get-own-property-descriptor.js"),o("../node_modules/core-js/modules/es.object.to-string.js"),o("../node_modules/core-js/modules/es.reflect.construct.js"),o("../node_modules/core-js/modules/es.regexp.exec.js"),o("../node_modules/core-js/modules/es.regexp.to-string.js"),o("../node_modules/core-js/modules/es.string.iterator.js"),o("../node_modules/core-js/modules/es.string.split.js"),o("../node_modules/core-js/modules/esnext.map.delete-all.js"),o("../node_modules/core-js/modules/esnext.map.every.js"),o("../node_modules/core-js/modules/esnext.map.filter.js"),o("../node_modules/core-js/modules/esnext.map.find.js"),o("../node_modules/core-js/modules/esnext.map.find-key.js"),o("../node_modules/core-js/modules/esnext.map.includes.js"),o("../node_modules/core-js/modules/esnext.map.key-of.js"),o("../node_modules/core-js/modules/esnext.map.map-keys.js"),o("../node_modules/core-js/modules/esnext.map.map-values.js"),o("../node_modules/core-js/modules/esnext.map.merge.js"),o("../node_modules/core-js/modules/esnext.map.reduce.js"),o("../node_modules/core-js/modules/esnext.map.some.js"),o("../node_modules/core-js/modules/esnext.map.update.js"),o("../node_modules/core-js/modules/web.dom-collections.for-each.js"),o("../node_modules/core-js/modules/web.dom-collections.iterator.js");var a=o("../node_modules/@babel/runtime/helpers/esm/slicedToArray.js"),r=(o("../node_modules/regenerator-runtime/runtime.js"),o("../node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js")),n=o("../node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),s=o("../node_modules/@babel/runtime/helpers/esm/createClass.js"),c=o("../node_modules/@babel/runtime/helpers/esm/inherits.js"),i=o("../node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn.js"),l=o("../node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js"),d=o("../node_modules/@babel/runtime/helpers/esm/typeof.js"),u=o("./src/base/util/type.ts"),h=o("./src/base/util/timer.ts"),m=o("../node_modules/@tencent/docs-user-agent/dist/index.js"),p=o.n(m),f=o("../node_modules/axios/index.js"),g=o.n(f),v=o("../packages/common-utils/src/url.ts"),j=o("./src/core/data/configService/spreadConfig.ts"),b=o("./src/external/resetLocation/utils.ts"),y=o("../packages/utils/src/safe.ts"),w=o("./src/base/index.ts"),S=o("./src/core/app/SpreadsheetApp.interface.ts"),x=o("../packages/model/src/spreadsheet/Spreadsheet.interface.ts"),_=o("../packages/services/src/dispose.ts");function I(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var o,a=Object(l.a)(e);if(t){var r=Object(l.a)(this).constructor;o=Reflect.construct(a,arguments,r)}else o=a.apply(this,arguments);return Object(i.a)(this,o)}}var C=function(e,t,o,a){var r,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,o):a;if("object"===("undefined"===typeof Reflect?"undefined":Object(d.a)(Reflect))&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,o,a);else for(var c=e.length-1;c>=0;c--)(r=e[c])&&(s=(n<3?r(s):n>3?r(t,o,s):r(t,o))||s);return n>3&&s&&Object.defineProperty(t,o,s),s},R=function(e,t){return function(o,a){t(o,a,e)}},O=!(p.a.isMobilePhone||p.a.isAndroidPad)&&!p.a.isIPad,L=function(t){Object(c.a)(i,t);var o=I(i);function i(e,t){var a;return Object(n.a)(this,i),(a=o.call(this)).app=e,a.spreadsheet=t,a.updateLocation=function(){var e=a.app,t=e.preview,o=e.view;if(!(null===t||void 0===t?void 0:t.isActive)){var r=o.getSheetLocation(),n=o.getCurrentPosition();if(n){var s=a.spreadsheet.activeSheetId,c={selectRange:r,sheetId:s,rowIndex:n.rowIndex,colIndex:n.colIndex};a.locCache.set(s,c)}}},a._register(Object(_.g)((function(){a.destroy()}),"destroyResetLocation")),a}return Object(s.a)(i,[{key:"init",value:function(){var e=Object(r.a)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.originSheetId=t,this.locCache=new Map,this.initEvent(),e.next=5,this.locate(this.originSheetId);case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"saveChangeToLocation",value:function(){var e=this.spreadsheet.activeSheetId,t=this.locCache.get(e);if(t){var o=t.sheetId,a=(new Date).getTime(),r=[];this.locCache.forEach((function(e){var t=Object(b.b)(!0,e.selectRange,e.rowIndex,e.colIndex);r.push([e.sheetId,t])}));var n=j.a.getConfig("padId"),s=j.a.getConfig("uid");this.syncToStorage(JSON.stringify(r),o,n,s,a)}}},{key:"saveChangeToServer",value:function(){var e=this.spreadsheet.activeSheetId,t=this.locCache.get(e);if(t){var o=t.selectRange,a=t.sheetId,r=t.rowIndex,n=t.colIndex,s=(new Date).getTime(),c=Object(b.b)(!1,o,r,n);this.syncToServer(c,a,s)}}},{key:"initEvent",value:function(){var e=this,t=Object(u.throttle)(this.updateLocation,500,this,!1);this.app.view.canvas.normalSelectData.emitter.on("updateSelection",(function(){t(),w.a.event.default.trigger("syncLoc")})),this.app.view.canvas.areaData.onUpdateOffset((function(){t(),w.a.event.default.trigger("syncLoc")})),w.a.event.sheetsBar.listen("switchSheetEnd",(function(){e.updateLocation(),e.saveChangeToServer(),e.saveChangeToLocation()})),w.a.event.default.listen("syncLoc",Object(u.throttle)(this.saveChangeToLocation,2e3,this,!1)),w.a.event.default.listen("syncLoc",Object(u.throttle)(this.saveChangeToServer,12e4,this,!1))}},{key:"syncToStorage",value:function(e,t,o,a,r){if(localStorage&&a&&o&&t)try{localStorage.setItem("user_".concat(a,"_").concat(o,"_location"),"".concat(e,"_").concat(r)),localStorage.setItem("user_".concat(a,"_").concat(o,"_activeSheet"),"".concat(t,"_").concat(r))}catch(n){console.error(n)}}},{key:"getActiveSheetFromStorage",value:function(){var e,t=j.a.getConfig("padId"),o=j.a.getConfig("uid");if(localStorage)try{e=localStorage.getItem("user_".concat(o,"_").concat(t,"_activeSheet"))}catch(s){console.error(s)}if(e){var r=e.split("_"),n=Object(a.a)(r,2);return{localSheetId:n[0],localUpdateTime:n[1]}}}},{key:"getUrlParam",value:function(){var t=Object(v.getQuery)("c")||Object(v.getQuery)("coord"),o=Object(v.getQuery)("tab");if(Object(v.getQuery)("coord")){var a=Object(v.removeURLParameters)(e.location.href,"coord");try{e.history.replaceState({},"",a)}catch(n){console.error(n)}}if(t){var r=Object(v.removeURLParameters)(e.location.href,"c");e.history.replaceState({},"",r)}return{coord:t,sheetId:o}}},{key:"syncToServer",value:function(e,t,o){var a=j.a.getConfig("globalPadId");return g()({url:"/sdc/updatebrowselocation",method:"POST",responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"padid=".concat(a,"&location=").concat(JSON.stringify({updateTime:o,coord:e,sheetId:t,isopen:1}),"&xsrf=").concat(Object(y.b)())}).then((function(e){})).catch((function(e){console.error("saveAsServer Error",e)}))}},{key:"getServer",value:function(){var e=Object(r.a)(regeneratorRuntime.mark((function e(){var t,o,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=j.a.getConfig("globalPadId"),o=Object(y.b)(),a="/sdc/getbrowselocation?padid=".concat(t,"&xsrf=").concat(o),e.next=5,g.a.get(a);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"locate",value:function(){var e=Object(r.a)(regeneratorRuntime.mark((function e(t){var o,a,r,n,s,c,i=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(j.a.getConfig("isLogin")){e.next=3;break}return e.abrupt("return");case 3:if(o=!1,a=this.spreadsheet.sheetManager.getSheetOptionsList(),this.applyStorageData(a,(function(e,t){i.app.view.saveSeletionCache(e,t)})),!(null===(r=this.getUrlParam())||void 0===r?void 0:r.coord)){e.next=9;break}return e.abrupt("return",this.applyUrlData(t,r));case 9:return n=h.a.wait(3e3).run((function(){o=!0,i.setLocationWithLocal(t)})),e.prev=10,e.next=13,this.getServer();case 13:200===(s=e.sent).status&&(0!==(null===(c=s.data)||void 0===c?void 0:c.retcode)||o?this.setLocationWithLocal(t):(h.a.erase(n),o=!1,this.handleResponse(c.result,t))),e.next=21;break;case 17:e.prev=17,e.t0=e.catch(10),console.error(e.t0),this.setLocationWithLocal(t);case 21:case"end":return e.stop()}}),e,this,[[10,17]])})));return function(t){return e.apply(this,arguments)}}()},{key:"handleResponse",value:function(e,t){e.sheetId?this.applyServerData(t,e):this.setLocationWithLocal(t)}},{key:"setLocationWithServer",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=this.app.view.getSheetLocation(),r=j.a.getConfig("isLogin"),n=a.row.flow;0===n&&void 0===a.xRange[0]?(this.originSheetId===e&&this.app.view.canvas.scrollApi.scrollToRenderFrom({row:t,col:o}),O&&r&&this.app.view.setSelection(e)):void 0===a.xRange[0]&&O&&r&&this.app.view.setFirstCellFocus(),this.updateLocation()}},{key:"setLocationWithLocal",value:function(e){var t=this.app.view.getSheetLocation();0===t.row.flow&&void 0===t.xRange[0]?O?(this.app.view.setSelection(e),this.app.view.setSheetScroll(e)):this.app.view.setSheetScroll(e):void 0===t.xRange[0]&&O&&this.app.view.setFirstCellFocus(),this.updateLocation()}},{key:"applyUrlData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getUrlParam();if(t.coord){var o=t.coord,a=t.sheetId,r=Object(b.a)(!1,o),n=r.selectRange,s=r.rowIndex,c=r.colIndex;a&&a===e?(this.app.view.saveSeletionCache(a,n),this.setLocationWithServer(a,s,c)):this.setLocationWithLocal(a)}else this.setLocationWithLocal(e)}},{key:"applyServerData",value:function(e,t){t||this.setLocationWithLocal(e);var o=t.coord,a=t.updateTime,r=t.sheetId,n=Object(b.a)(!1,o),s=n.selectRange,c=n.rowIndex,i=n.colIndex,l=this.getActiveSheetFromStorage(),d=r;if(l){var u=l.localSheetId;a<+l.localUpdateTime&&(d=u)}if(e)if(e!==r)this.setLocationWithLocal(e);else{var h=this.app.view.getSelectionCache(r);(null===h||void 0===h?void 0:h.updateTime)?a>h.updateTime?(this.app.view.saveSeletionCache(r,s),this.setLocationWithServer(r,c,i)):this.setLocationWithLocal(r):(this.app.view.saveSeletionCache(r,s),this.setLocationWithServer(r,c,i))}else this.setLocationWithLocal(d)}},{key:"applyStorageData",value:function(e,t){var o=this,r=this.getTotalDataFromStorage();if(r){var n=r.split("_"),s=Object(a.a)(n,2),c=s[0],i=s[1];JSON.parse(c).forEach((function(e){var r=Object(a.a)(e,2),n=r[0],s=r[1],c=Object(b.a)(!0,s),l=c.selectRange,d=c.rowIndex,u=c.colIndex;l.updateTime=+i,o.locCache.set(n,{sheetId:n,selectRange:l,rowIndex:d,colIndex:u}),null===t||void 0===t||t(n,l)}))}else for(var l=0;l<e.length;l++){var d=e[l].id,u=this.getSheetDataFromStorage(d);if(u){var h=u.split("_"),m=Object(a.a)(h,2),p=m[0],f=m[1],g=Object(b.a)(!0,p).selectRange;g.updateTime=+f,null===t||void 0===t||t(d,g),this.removeSheetDataFromStorage(d)}}}},{key:"getSheetDataFromStorage",value:function(t){var o,a=j.a.getConfig("globalPadId"),r=j.a.getConfig("uid");if(e.localStorage)try{o=e.localStorage.getItem("user_".concat(r,"_").concat(a,"_").concat(t))}catch(n){console.error(n)}return o}},{key:"removeSheetDataFromStorage",value:function(t){var o=j.a.getConfig("globalPadId"),a=j.a.getConfig("uid");if(e.localStorage)try{e.localStorage.removeItem("user_".concat(a,"_").concat(o,"_").concat(t)),e.localStorage.removeItem("user_".concat(a,"_").concat(o,"_activeSheet"))}catch(r){console.error(r)}}},{key:"getTotalDataFromStorage",value:function(){var t,o=j.a.getConfig("padId"),a=j.a.getConfig("uid");if(e.localStorage)try{t=e.localStorage.getItem("user_".concat(a,"_").concat(o,"_location"))}catch(r){console.error(r)}return t}},{key:"destroy",value:function(){this.originSheetId=null,this.locCache=new Map}}]),i}(_.a);L=C([R(0,S.a),R(1,x.a)],L),t.default=L}.call(this,o("../node_modules/webpack/buildin/global.js"))},"./src/external/resetLocation/utils.ts":function(e,t,o){"use strict";o.d(t,"b",(function(){return s})),o.d(t,"a",(function(){return c}));o("../node_modules/core-js/modules/es.array.concat.js"),o("../node_modules/core-js/modules/es.array.filter.js"),o("../node_modules/core-js/modules/es.array.index-of.js"),o("../node_modules/core-js/modules/es.array.join.js"),o("../node_modules/core-js/modules/es.number.constructor.js"),o("../node_modules/core-js/modules/es.regexp.exec.js"),o("../node_modules/core-js/modules/es.string.match.js"),o("../node_modules/core-js/modules/es.string.split.js");var a=o("../packages/model/src/range/hexRangeUtils.ts"),r=o("../packages/model/src/range/gridRangeUtils.ts"),n=o("./src/base/util/html.ts");function s(e,t,o,r){var n=t.xRange,s=t.yRange,c=t.col,i=t.row,l="";return l+=Object(a.colIndex2ColChar)(n[0]||0)+((s[0]||0)+1),l+=e?Object(a.colIndex2ColChar)(c.flow):Object(a.colIndex2ColChar)(r),l+=c.frozen||0,l+=e?Object(a.colIndex2ColChar)(i.flow):Object(a.colIndex2ColChar)(o),l+=i.frozen||0,l=encodeURIComponent(l)}function c(e,t){var o={selectRange:{xRange:[0,0],yRange:[0,0],row:{frozen:0,flow:0},col:{frozen:0,flow:0}},rowIndex:0,colIndex:0};return t?o=decodeURIComponent(Object(n.c)(t)).indexOf("$")>-1?function(e,t){var o={xRange:[0,0],yRange:[0,0],row:{frozen:0,flow:0},col:{frozen:0,flow:0}},a=0,n=0,s=t.split("$"),c=Object(r.toRC)(s[0]),i=Object(r.toRC)(s[1]);s&&s.length>=6&&c&&i&&(o.xRange=[c.col,i.col],o.yRange=[c.row,i.row],o.col.flow=e?Number(s[2]):0,o.col.frozen=Number(s[3]),o.row.flow=e?Number(s[4]):0,o.row.frozen=Number(s[5]),e||(n=Number(s[2]),a=Number(s[4])));return{selectRange:o,rowIndex:a,colIndex:n}}(e,t):function(e,t){var o={xRange:[0,0],yRange:[0,0],row:{frozen:0,flow:0},col:{frozen:0,flow:0}},a=0,n=0,s=t.match(/([A-Z]+[0-9]+)/gi);if(s&&3===s.length){var c=Object(r.toRC)(s[0]),i=Object(r.toRC)(s[0]),l=Object(r.toRC)(s[1]),d=Object(r.toRC)(s[2]);c&&i&&l&&d&&(o.xRange=[c.col,i.col],o.yRange=[c.row,i.row],o.col.flow=e?l.col:0,o.col.frozen=l.row+1,o.row.flow=e?d.col:0,o.row.frozen=d.row+1,e||(n=l.col,a=d.col))}return{selectRange:o,rowIndex:a,colIndex:n}}(e,t):o}}}]);
//# sourceMappingURL=pc-bundle_reset_location-ee0c151b32.js.map